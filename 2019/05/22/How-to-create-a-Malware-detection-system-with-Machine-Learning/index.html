<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>How to Create a Malware Detection System With Machine Learning | evilsocket</title>
<meta name="description" content="">


  <link rel="alternate" href="/atom.xml" title="evilsocket" type="application/atom+xml">


<link rel="icon" href="/images/favicon.ico">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="How to Create a Malware Detection System With Machine Learning">
<meta property="og:description" content="">
<meta property="og:url" content="/2019/05/22/How-to-create-a-Malware-detection-system-with-Machine-Learning/">
<meta property="og:site_name" content="evilsocket">

  
  
    <meta property="og:image" content="https://i.imgur.com/cBCBdlH.png">
  


<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="How to Create a Malware Detection System With Machine Learning">
<meta name="twitter:description" content="">

<!-- Schema.org JSON-LD -->


<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.evilsocket.net/2019/05/22/How-to-create-a-Malware-detection-system-with-Machine-Learning/"},"headline":"How to Create a Malware Detection System With Machine Learning","description":"","image":"https://www.evilsocket.nethttps://i.imgur.com/cBCBdlH.png","datePublished":"2019-05-22T21:59:13.000Z","dateModified":"2020-05-26T20:30:56.000Z","author":{"@type":"Person","name":"Simone Margaritelli","description":"Italian cybersecurity researcher and open-source developer","url":"https://www.evilsocket.net","sameAs":["https://github.com/evilsocket","https://twitter.com/evilsocket","http://it.linkedin.com/in/simonemargaritelli/"],"jobTitle":"Security Researcher","worksFor":{"@type":"Organization","name":"Independent"}},"publisher":{"@type":"Organization","name":"evilsocket","url":"https://www.evilsocket.net","logo":{"@type":"ImageObject","url":"https://www.evilsocket.net/images/glider.png"}},"keywords":"ai, ergo, keras, tensorflow, tf, deep learning, dnn, machine learning, neural networks, deep neural networks, cuda, nvidia, malware, malware detection, computer virus, windows pe, portable executable","articleSection":"Technology","inLanguage":"en"}
</script>


<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Styles -->
<link rel="stylesheet" href="/css/style.css">


<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-22026549-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-22026549-1');
</script>


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="post-page">
  <header class="site-header">
  <div class="header-inner">
    <div class="site-branding">
      <a href="/" class="site-logo">
        
          <img src="/images/glider.png" alt="evilsocket" width="50" height="50">
        
        <div class="site-title-group">
          <span class="site-title">evilsocket</span>
          <span class="site-motto">Preoccupied with a single leaf, you won't see the tree. Preoccupied with a single tree... you'll miss the entire forest.</span>
        </div>
      </a>
    </div>
    
    <nav class="site-nav">
      
        <a href="/" class="nav-link">
          HOME
        </a>
      
        <a href="/atom.xml" class="nav-link">
          RSS
        </a>
      
    </nav>
  </div>
</header>

  
  <main class="main-content">
    <article class="post-full">
  <header class="post-header">
    <h1 class="post-title">How to Create a Malware Detection System With Machine Learning</h1>
    <div class="post-meta">
      BY <span class="post-author">Simone Margaritelli</span>
      — <time datetime="2019-05-22T21:59:13.000Z">22 May 2019</time>
      
        — <a href="/tags/ai/" class="post-category">ai</a>, <a href="/tags/ergo/" class="post-category">ergo</a>, <a href="/tags/keras/" class="post-category">keras</a>, <a href="/tags/tensorflow/" class="post-category">tensorflow</a>, <a href="/tags/tf/" class="post-category">tf</a>, <a href="/tags/deep-learning/" class="post-category">deep learning</a>, <a href="/tags/dnn/" class="post-category">dnn</a>, <a href="/tags/machine-learning/" class="post-category">machine learning</a>, <a href="/tags/neural-networks/" class="post-category">neural networks</a>, <a href="/tags/deep-neural-networks/" class="post-category">deep neural networks</a>, <a href="/tags/cuda/" class="post-category">cuda</a>, <a href="/tags/nvidia/" class="post-category">nvidia</a>, <a href="/tags/malware/" class="post-category">malware</a>, <a href="/tags/malware-detection/" class="post-category">malware detection</a>, <a href="/tags/computer-virus/" class="post-category">computer virus</a>, <a href="/tags/windows-pe/" class="post-category">windows pe</a>, <a href="/tags/portable-executable/" class="post-category">portable executable</a>
      
    </div>
  </header>

  <div class="post-content">
    <p>In this post we’ll talk about two topics I love and that have been central elements of my (private) research for the last ~7 years: machine learning and malware detection.</p>
<p>Having a rather empirical and definitely non-academic education, I know the struggle of a passionate developer who wants to approach machine learning and is trying to make sense of formal definitions, linear algebra and whatnot. Therefore, I’ll try to keep this as practical as possible in order to allow even the less <em>formally-educated</em> reader to understand and possibly start having fun with neural networks. </p>
<p>Moreover, most of the resources out there focus on very known problems such as handwritten digit recognition on the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/MNIST_database">MNIST dataset</a> (the “hello world” of machine learning), while leaving to the reader’s imagination how more complex features engineering systems are supposed to work and generally what to do with inputs that are not images.</p>
<p>TL;DR: <em>I’m bad at math, MNIST is boring and detecting malware is more fun :D</em></p>
<p>I’ll also use this as an example use-case for some new features of <a target="_blank" rel="noopener" href="https://github.com/evilsocket/ergo">ergo</a>, a project me and <a target="_blank" rel="noopener" href="https://twitter.com/chiconara">chiconara</a> started some time ago to automate machine learning models creation, data encoding, training on GPU, benchmarking and deployment at scale.</p>
<p>The source code related to this post is available <a target="_blank" rel="noopener" href="https://github.com/evilsocket/ergo-pe-av">here</a>.</p>
<p><strong>Important note: this project alone does NOT constitute a valid replacement for your commercial antivirus.</strong></p>
<center>
<img src="https://i.imgur.com/cBCBdlH.png">
</center>

<h3 id="Problem-Definition-and-Dataset"><a href="#Problem-Definition-and-Dataset" class="headerlink" title="Problem Definition and Dataset"></a>Problem Definition and Dataset</h3><center>
<img src="https://i.imgur.com/2JphgOS.jpg">
</center>

<p>Traditional malware detection engines rely on the use of signatures - unique values that have been manually selected by a malware researcher to identify the presence of malicious code while making sure there are no collisions in the non-malicious samples group (that’d be called a <em>“false positive”</em>).</p>
<p>The problems with this approach are several, among others it’s usually easy to bypass (depending on the type of signature, the change of a single bit or just a few bytes in the malicious code could make the malware undetectable) and it doesn’t scale very well when the number of researchers is orders of magnitude smaller than the number of unique malware families they need to manually reverse engineer, identify and write signatures for.</p>
<p>Our goal is teaching a computer, more specifically an artificial neural network, to detect Windows malware without relying on any explicit signatures database that we’d need to create, but by simply ingesting the dataset of malicious files we want to be able to detect and learning from it to distinguish between malicious code or not, both inside the dataset itself but, most importantly, while processing new, unseen samples. Our only knowledge is which of those files are malicious and which are not, but not what specifically makes them so, we’ll let the ANN do the rest.</p>
<p>In order to do this, I’ve collected approximately 200,000 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Portable_Executable">Windows PE</a> samples, divided evenly in malicious (<em>with 10+ detections on VirusTotal</em>) and clean (<em>known and with 0 detections on VirusTotal</em>). Since training and testing the model on the very same dataset wouldn’t make much sense (as it could perform extremely well on the training set, but not being able to generalize at all on new samples), this dataset will be automatically divided by ergo into 3 sub sets:</p>
<ul>
<li>A <em>training set</em>, with 70% of the samples, used for training.</li>
<li>A <em>validation set</em>, with 15% of the samples, used to benchmark the model at each training epoch.</li>
<li>A <em>test set</em>, with 15% of the samples, used to benchmark the model after training.</li>
</ul>
<p>Needless to say, the amount of (correctly labeled) samples in your dataset is key for the model accuracy, its ability to correcly separate the two classes and generalize to unseen samples - the more you’ll use in your training process, the better. Besides, ideally the dataset should be periodically updated with newer samples and the model retrained in order to keep its accuracy high over time even when new unique samples appear in the wild (namely: wget + crontab + ergo).</p>
<p>Due to the size of the specific dataset I’ve used for this post, I can’t share it without killing my bandwidth:</p>
<center>
<img src="https://i.imgur.com/kEsLLOP.jpg">
</center>

<p>However, <a target="_blank" rel="noopener" href="https://drive.google.com/file/d/1HIJShr0GvQCUp_0R_kQe_WLG5PippurN/view?usp=sharing">I uploaded the dataset.csv file on Google Drive</a>, it’s ~340MB extracted and you can use it to reproduce the results of this post.</p>
<h3 id="The-Portable-Executable-format"><a href="#The-Portable-Executable-format" class="headerlink" title="The Portable Executable format"></a>The Portable Executable format</h3><p>The Windows PE format is <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format">abundantly documented</a> and many good resources to understand the internals, such as <a target="_blank" rel="noopener" href="https://twitter.com/angealbertini">Ange Albertini</a>‘s <em>“<a target="_blank" rel="noopener" href="https://www.slideshare.net/ange4771/44con2013-workshop-exploring-the-portable-executable-format">Exploring the Portable Executable format</a>“</em> 44CON 2013 presentation (from where I took the following picture) are available online for free, therefore I won’t spend too much time going into details.</p>
<p>The key facts we must keep in mind are:</p>
<ul>
<li>A PE has several headers describing its properties and various addressing details, such as the base address the PE is going to be loaded in memory and where the entry point is.</li>
<li>A PE has several sections, each one containing data (constants, global variables, etc), code (in which case the section is marked as executable) or sometimes both.</li>
<li>A PE contains a declaration of what API are imported and from what system libraries. </li>
</ul>
<center>
<img src="https://i.imgur.com/olmDveV.png" width="100%">
<small><a href="https://www.slideshare.net/ange4771/44con2013-workshop-exploring-the-portable-executable-format" target="blank">Credits to Ange Albertini</a></small>
</center>

<p>For instance, this is how the Firefox PE sections look like:</p>
<center>
<img src="https://i.imgur.com/Ht745tL.png" width="100%">
<small><a href="https://bsodtutorials.wordpress.com/2014/11/14/upx-packing-and-anti-packing-techniques/" target="blank">Credits to the "Machines Can Think" blog</a></small>
</center>

<p>While in some cases, if the PE has been processed with a <a target="_blank" rel="noopener" href="https://upx.github.io/">packer such as UPX</a>, its sections might look a bit different, as the main code and data sections are compressed and a code stub to decompress at runtime it’s added:</p>
<center>
<img src="https://i.imgur.com/JDAdMux.png" width="100%">
<small><a href="https://bsodtutorials.wordpress.com/2014/11/14/upx-packing-and-anti-packing-techniques/" target="blank">Credits to the "Machines Can Think" blog</a></small>
</center>

<p>What we’re going to do now is looking at how we can encode these values that are very heterogeneous in nature (they’re numbers of all types of intervals and strings of variable length) into a vector of scalar numbers, each normalized in the interval [0.0,1.0], and of constant length. This is the type of input that our machine learning model is able to understand. </p>
<p>The process of determining which features of the PE to consider is possibly the most important part of designing any machine learning system and it’s called <em>features engineering</em>, while the act of reading these values and encoding them is called <em>features extraction</em>.</p>
<h3 id="Features-Engineering"><a href="#Features-Engineering" class="headerlink" title="Features Engineering"></a>Features Engineering</h3><p>After creating the project with:</p>
<pre><code>ergo create ergo-pe-av</code></pre>
<p>I started implementing the features extraction algorithm, inside the <a target="_blank" rel="noopener" href="https://github.com/evilsocket/ergo-pe-av/blob/master/encoder.py#L122">encode.py file</a>, as a very simple (150 lines including comments and multi line strings) starting point that yet provides us enough information to reach interesting accuracy levels and that could easily be extended in the future with additional features.</p>
<pre><code>cd ergo-pe-av
vim encode.py</code></pre>
<p>The first 11 scalars of our vector encode a set of boolean properties that <a target="_blank" rel="noopener" href="http://lief.quarkslab.com/">LIEF</a>, the amazing library from QuarksLab I’m using, parses from the PE - each property is encoded to a <code>1.0</code> if true, or to a <code>0.0</code> if false:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>pe.has_configuration</code></td>
<td>True if the PE has a <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format#the-load-configuration-structure-image-only">Load Configuration</a></td>
</tr>
<tr>
<td><code>pe.has_debug</code></td>
<td>True if the PE has a Debug section.</td>
</tr>
<tr>
<td><code>pe.has_exceptions</code></td>
<td>True if the PE is using exceptions.</td>
</tr>
<tr>
<td><code>pe.has_exports</code></td>
<td>True if the PE has any exported symbol.</td>
</tr>
<tr>
<td><code>pe.has_imports</code></td>
<td>True if the PE is importing any symbol.</td>
</tr>
<tr>
<td><code>pe.has_nx</code></td>
<td>True if the PE has the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/NX_bit">NX bit</a> set.</td>
</tr>
<tr>
<td><code>pe.has_relocations</code></td>
<td>True if the PE has relocation entries.</td>
</tr>
<tr>
<td><code>pe.has_resources</code></td>
<td>True if the PE has any resource.</td>
</tr>
<tr>
<td><code>pe.has_rich_header</code></td>
<td>True if a rich header is present.</td>
</tr>
<tr>
<td><code>pe.has_signature</code></td>
<td>True if the PE is digitally signed.</td>
</tr>
<tr>
<td><code>pe.has_tls</code></td>
<td>True if the PE is using <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format#the-tls-section">TLS</a></td>
</tr>
</tbody></table>
<p>Then 64 elements follow, representing the first 64 bytes of the PE entry point function, each normalized to <code>[0.0,1.0]</code> by dividing each of them by <code>255</code> - this will help the model detecting those executables that have very distinctive entrypoints that only vary slightly among different samples of the same family (you can think about this as a very basic signature):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ep_bytes  =  [<span class="number">0</span>]  *  <span class="number">64</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	ep_offset = pe.entrypoint - pe.optional_header.imagebase</span><br><span class="line">	ep_bytes = [<span class="built_in">int</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> raw[ep_offset:ep_offset+<span class="number">64</span>]]</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">	log.warning(<span class="string">&quot;can&#x27;t get entrypoint bytes from %s: %s&quot;</span>, filepath, e)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_entrypoint</span>(<span class="params">ep</span>):</span></span><br><span class="line">	<span class="keyword">while</span> <span class="built_in">len</span>(ep) &lt; <span class="number">64</span>: <span class="comment"># pad</span></span><br><span class="line">		ep += [<span class="number">0.0</span>]</span><br><span class="line">	<span class="keyword">return</span> np.array(ep) / <span class="number">255.0</span> <span class="comment"># normalize</span></span><br></pre></td></tr></table></figure>
<p>Then an histogram of the repetitions of each byte of the ASCII table (therefore size 256) in the binary file follows - this data point will encode basic statistical information about the raw contents of the file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the &#x27;raw&#x27; argument holds the entire contents of the file</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_histogram</span>(<span class="params">raw</span>):</span></span><br><span class="line">	histo = np.bincount(np.frombuffer(raw, dtype=np.uint8), minlength=<span class="number">256</span>)</span><br><span class="line">	histo = histo / histo.<span class="built_in">sum</span>() <span class="comment"># normalize</span></span><br><span class="line">	<span class="keyword">return</span>  histo</span><br></pre></td></tr></table></figure>

<p>The next thing I decided to encode in the features vector is the import table, as the API being used by the PE is quite a relevant information :D In order to do this <a target="_blank" rel="noopener" href="https://github.com/evilsocket/ergo-pe-av/blob/master/encoder.py#L22">I manually selected the 150 most common libraries</a> in my dataset and for each API being used by the PE I increment by one the column of the relative library, creating another histogram of 150 values then normalized by the total amount of API being imported:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the &#x27;pe&#x27; argument holds the PE object parsed by LIEF</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_libraries</span>(<span class="params">pe</span>):</span></span><br><span class="line">    <span class="keyword">global</span> libraries</span><br><span class="line"></span><br><span class="line">    imports = &#123;dll.name.lower():[api.name <span class="keyword">if</span> <span class="keyword">not</span> api.is_ordinal <span class="keyword">else</span> api.iat_address \</span><br><span class="line">                           <span class="keyword">for</span> api <span class="keyword">in</span> dll.entries] <span class="keyword">for</span> dll <span class="keyword">in</span> pe.imports&#125;</span><br><span class="line"></span><br><span class="line">    libs = np.array([<span class="number">0.0</span>] * <span class="built_in">len</span>(libraries))</span><br><span class="line">    <span class="keyword">for</span> idx, lib <span class="keyword">in</span> <span class="built_in">enumerate</span>(libraries):</span><br><span class="line">        calls = <span class="number">0</span></span><br><span class="line">        dll   = <span class="string">&quot;%s.dll&quot;</span> % lib</span><br><span class="line">        <span class="keyword">if</span> lib <span class="keyword">in</span> imports:</span><br><span class="line">            calls = <span class="built_in">len</span>(imports[lib])</span><br><span class="line">        <span class="keyword">elif</span> dll <span class="keyword">in</span> imports:</span><br><span class="line">            calls = <span class="built_in">len</span>(imports[dll])</span><br><span class="line">        libs[idx] += calls</span><br><span class="line">    tot = libs.<span class="built_in">sum</span>()</span><br><span class="line">    <span class="keyword">return</span> ( libs / tot ) <span class="keyword">if</span> tot &gt; <span class="number">0</span> <span class="keyword">else</span> libs <span class="comment"># normalize</span></span><br></pre></td></tr></table></figure>
<p>We proceed to encode the ratio of the PE size on disk vs the size it’ll have in memory (its <em>virtual size</em>):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">min</span>(sz, pe.virtual_size) / <span class="built_in">max</span>(sz, pe.virtual_size)</span><br></pre></td></tr></table></figure>

<p>Next, we want to encode some information about the PE sections, such the amount of them containing code vs the ones containing data, the sections marked as executable, the average <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Entropy_(information_theory)">Shannon entropy</a> of each one and the average ratio of their size vs their virtual size - these datapoints will tell the model if and how the PE is packed/compressed/obfuscated:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_sections</span>(<span class="params">pe</span>):</span></span><br><span class="line">    sections = [&#123; \</span><br><span class="line">        <span class="string">&#x27;characteristics&#x27;</span>: <span class="string">&#x27;,&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, s.characteristics_lists)),</span><br><span class="line">        <span class="string">&#x27;entropy&#x27;</span>: s.entropy,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: s.name,</span><br><span class="line">        <span class="string">&#x27;size&#x27;</span>: s.size,</span><br><span class="line">        <span class="string">&#x27;vsize&#x27;</span>: s.virtual_size &#125; <span class="keyword">for</span> s <span class="keyword">in</span> pe.sections]</span><br><span class="line"></span><br><span class="line">    num_sections = <span class="built_in">len</span>(sections)</span><br><span class="line">    max_entropy  = <span class="built_in">max</span>([s[<span class="string">&#x27;entropy&#x27;</span>] <span class="keyword">for</span> s <span class="keyword">in</span> sections]) <span class="keyword">if</span> num_sections <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">    max_size     = <span class="built_in">max</span>([s[<span class="string">&#x27;size&#x27;</span>] <span class="keyword">for</span> s <span class="keyword">in</span> sections]) <span class="keyword">if</span> num_sections <span class="keyword">else</span> <span class="number">0.0</span> </span><br><span class="line">    min_vsize    = <span class="built_in">min</span>([s[<span class="string">&#x27;vsize&#x27;</span>] <span class="keyword">for</span> s <span class="keyword">in</span> sections]) <span class="keyword">if</span> num_sections <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">    norm_size    = (max_size / min_vsize) <span class="keyword">if</span> min_vsize &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [ \</span><br><span class="line">        <span class="comment"># code_sections_ratio</span></span><br><span class="line">        (<span class="built_in">len</span>([s <span class="keyword">for</span> s <span class="keyword">in</span> sections <span class="keyword">if</span> <span class="string">&#x27;SECTION_CHARACTERISTICS.CNT_CODE&#x27;</span> <span class="keyword">in</span> s[<span class="string">&#x27;characteristics&#x27;</span>]]) / num_sections) <span class="keyword">if</span> num_sections <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">        <span class="comment"># pec_sections_ratio</span></span><br><span class="line">        (<span class="built_in">len</span>([s <span class="keyword">for</span> s <span class="keyword">in</span> sections <span class="keyword">if</span> <span class="string">&#x27;SECTION_CHARACTERISTICS.MEM_EXECUTE&#x27;</span> <span class="keyword">in</span> s[<span class="string">&#x27;characteristics&#x27;</span>]]) / num_sections) <span class="keyword">if</span> num_sections <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">        <span class="comment"># sections_avg_entropy</span></span><br><span class="line">        ((<span class="built_in">sum</span>([s[<span class="string">&#x27;entropy&#x27;</span>] <span class="keyword">for</span> s <span class="keyword">in</span> sections]) / num_sections) / max_entropy) <span class="keyword">if</span> max_entropy &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span>,</span><br><span class="line">        <span class="comment"># sections_vsize_avg_ratio</span></span><br><span class="line">        ((<span class="built_in">sum</span>([s[<span class="string">&#x27;size&#x27;</span>] / s[<span class="string">&#x27;vsize&#x27;</span>] <span class="keyword">for</span> s <span class="keyword">in</span> sections]) / num_sections) / norm_size) <span class="keyword">if</span> norm_size &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span>,</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<p>Last, we glue all the pieces into one single vector of size <code>486</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v = np.concatenate([ \</span><br><span class="line">	encode_properties(pe),</span><br><span class="line">	encode_entrypoint(ep_bytes),</span><br><span class="line">	encode_histogram(raw),</span><br><span class="line">	encode_libraries(pe),</span><br><span class="line">	[ <span class="built_in">min</span>(sz, pe.virtual_size) / <span class="built_in">max</span>(sz, pe.virtual_size)],</span><br><span class="line">	encode_sections(pe)</span><br><span class="line">	])</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> v</span><br></pre></td></tr></table></figure>
<p>The only thing left to do, is telling our model how to encode the input samples by customizing the <code>prepare_input</code> function in the <code>prepare.py</code> file previously created by ergo - the following implementation supports the encoding of a file given its path, given its contents (sent as a file upload to the ergo API), or just the evaluation on a raw vector of scalar features:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># used by `ergo encode &lt;path&gt; &lt;folder&gt;` to encode a PE in a vector of scalar features</span></span><br><span class="line"><span class="comment"># used by `ergo serve &lt;path&gt;` to parse the input query before running the inference</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare_input</span>(<span class="params">x, is_encoding = <span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="comment"># file upload</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, werkzeug.datastructures.FileStorage):</span><br><span class="line">        <span class="keyword">return</span> encoder.encode_pe(x)</span><br><span class="line">    <span class="comment"># file path</span></span><br><span class="line">    <span class="keyword">elif</span> os.path.isfile(x) :</span><br><span class="line">        <span class="keyword">return</span> encoder.encode_pe(x)</span><br><span class="line">    <span class="comment"># raw vector</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> x.split(<span class="string">&#x27;,&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Now we have everything we need to transform something <a target="_blank" rel="noopener" href="https://www.virustotal.com/gui/file/0830ea172eb905973e52c44f8a5ce44eccba53402ac81ddb4f4d612e8d069a25/detection">like this</a>, to something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0.0,0.0,0.0,0.0,1.0,0.0,0.0,1.0,1.0,0.0,0.0,0.333333333333,0.545098039216,0.925490196078,0.41568627451,1.0,0.407843137255,0.596078431373,0.192156862745,0.250980392157,0.0,0.407843137255,0.188235294118,0.149019607843,0.250980392157,0.0,0.392156862745,0.63137254902,0.0,0.0,0.0,0.0,0.313725490196,0.392156862745,0.537254901961,0.145098039216,0.0,0.0,0.0,0.0,0.513725490196,0.925490196078,0.407843137255,0.325490196078,0.337254901961,0.341176470588,0.537254901961,0.396078431373,0.909803921569,0.2,0.858823529412,0.537254901961,0.364705882353,0.988235294118,0.41568627451,0.0078431372549,1.0,0.0823529411765,0.972549019608,0.188235294118,0.250980392157,0.0,0.349019607843,0.513725490196,0.0509803921569,0.0941176470588,0.270588235294,0.250980392157,0.0,1.0,0.513725490196,0.0509803921569,0.109803921569,0.270588235294,0.250980392157,0.870149739583,0.00198567708333,0.00146484375,0.000944010416667,0.000830078125,0.00048828125,0.000162760416667,0.000325520833333,0.000569661458333,0.000130208333333,0.000130208333333,8.13802083333e-05,0.000553385416667,0.000390625,0.000162760416667,0.00048828125,0.000895182291667,8.13802083333e-05,0.000179036458333,8.13802083333e-05,0.00048828125,0.001611328125,0.000162760416667,9.765625e-05,0.000472005208333,0.000146484375,3.25520833333e-05,8.13802083333e-05,0.000341796875,0.000130208333333,3.25520833333e-05,1.62760416667e-05,0.001171875,4.8828125e-05,0.000130208333333,1.62760416667e-05,0.00372721354167,0.000699869791667,6.51041666667e-05,8.13802083333e-05,0.000569661458333,0.0,0.000113932291667,0.000455729166667,0.000146484375,0.000211588541667,0.000358072916667,1.62760416667e-05,0.00208333333333,0.00087890625,0.000504557291667,0.000846354166667,0.000537109375,0.000439453125,0.000358072916667,0.000276692708333,0.000504557291667,0.000423177083333,0.000276692708333,3.25520833333e-05,0.000211588541667,0.000146484375,0.000130208333333,0.0001953125,0.00577799479167,0.00109049479167,0.000227864583333,0.000927734375,0.002294921875,0.000732421875,0.000341796875,0.000244140625,0.000276692708333,0.000211588541667,3.25520833333e-05,0.000146484375,0.00135091145833,0.000341796875,8.13802083333e-05,0.000358072916667,0.00193684895833,0.0009765625,0.0009765625,0.00123697916667,0.000699869791667,0.000260416666667,0.00078125,0.00048828125,0.000504557291667,0.000211588541667,0.000113932291667,0.000260416666667,0.000472005208333,0.00029296875,0.000472005208333,0.000927734375,0.000211588541667,0.00113932291667,0.0001953125,0.000732421875,0.00144856770833,0.00348307291667,0.000358072916667,0.000260416666667,0.00206705729167,0.001171875,0.001513671875,6.51041666667e-05,0.00157877604167,0.000504557291667,0.000927734375,0.00126953125,0.000667317708333,1.62760416667e-05,0.00198567708333,0.00109049479167,0.00255533854167,0.00126953125,0.00109049479167,0.000325520833333,0.000406901041667,0.000325520833333,8.13802083333e-05,3.25520833333e-05,0.000244140625,8.13802083333e-05,4.8828125e-05,0.0,0.000406901041667,0.000602213541667,3.25520833333e-05,0.00174153645833,0.000634765625,0.00068359375,0.000130208333333,0.000130208333333,0.000309244791667,0.00105794270833,0.000244140625,0.003662109375,0.000244140625,0.00245768229167,0.0,1.62760416667e-05,0.002490234375,3.25520833333e-05,1.62760416667e-05,9.765625e-05,0.000504557291667,0.000211588541667,1.62760416667e-05,4.8828125e-05,0.000179036458333,0.0,3.25520833333e-05,3.25520833333e-05,0.000211588541667,0.000162760416667,8.13802083333e-05,0.0,0.000260416666667,0.000260416666667,0.0,4.8828125e-05,0.000602213541667,0.000374348958333,3.25520833333e-05,0.0,9.765625e-05,0.0,0.000113932291667,0.000211588541667,0.000146484375,6.51041666667e-05,0.000667317708333,4.8828125e-05,0.000276692708333,4.8828125e-05,8.13802083333e-05,1.62760416667e-05,0.000227864583333,0.000276692708333,0.000146484375,3.25520833333e-05,0.000276692708333,0.000244140625,8.13802083333e-05,0.0001953125,0.000146484375,9.765625e-05,6.51041666667e-05,0.000358072916667,0.00113932291667,0.000504557291667,0.000504557291667,0.0005859375,0.000813802083333,4.8828125e-05,0.000162760416667,0.000764973958333,0.000244140625,0.000651041666667,0.000309244791667,0.0001953125,0.000667317708333,0.000162760416667,4.8828125e-05,0.0,0.000162760416667,0.000553385416667,1.62760416667e-05,0.000130208333333,0.000146484375,0.000179036458333,0.000276692708333,9.765625e-05,0.000406901041667,0.000162760416667,3.25520833333e-05,0.000211588541667,8.13802083333e-05,1.62760416667e-05,0.000130208333333,8.13802083333e-05,0.000276692708333,0.000504557291667,9.765625e-05,1.62760416667e-05,9.765625e-05,3.25520833333e-05,1.62760416667e-05,0.0,0.00138346354167,0.000732421875,6.51041666667e-05,0.000146484375,0.000341796875,3.25520833333e-05,4.8828125e-05,4.8828125e-05,0.000260416666667,3.25520833333e-05,0.00068359375,0.000960286458333,0.000227864583333,9.765625e-05,0.000244140625,0.000813802083333,0.000179036458333,0.000439453125,0.000341796875,0.000146484375,0.000504557291667,0.000504557291667,9.765625e-05,0.00760091145833,0.0,0.370786516854,0.0112359550562,0.168539325843,0.0,0.0,0.0337078651685,0.0,0.0,0.0,0.303370786517,0.0112359550562,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0561797752809,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0449438202247,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.0,0.25,0.25,0.588637653212,0.055703845605</span><br></pre></td></tr></table></figure>

<p>Assuming you have a folder containing malicious samples in the <code>pe-malicious</code> subfolder and clean ones in <code>pe-legit</code> (feel free to give them any name, but the folder names will become the labels associated to each of the samples), you can start the encoding process to a <code>dataset.csv</code> file that our model can use for training with:</p>
<pre><code>ergo encode /path/to/ergo-pe-av /path/to/dataset --output /path/to/dataset.csv</code></pre>
<p>Take a coffee and relax, depending on the size of your dataset and how fast the disk where it’s stored is, this process might take quite some time :)</p>
<h3 id="An-useful-property-of-the-vectors"><a href="#An-useful-property-of-the-vectors" class="headerlink" title="An useful property of the vectors"></a>An useful property of the vectors</h3><p>While ergo is encoding our dataset, let’s take a break to discuss an interesting property of these vectors and how to use it. </p>
<p>It’ll be clear to the reader by now that structurally and/or behaviourally similar executables will have similar vectors, where the distance/difference from one vector and another can be measured, for instance, by using the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cosine_similarity">Cosine similarity</a>, defined as:</p>
<center>
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/1d94e5903f7936d3c131e040ef2c51b473dd071d">
</center>

<p>This metric can be used, among other things, to extract from the dataset (that, let me remind, is a huge set of files you don’t really know much about other if they’re malicious or not) all the samples of a given family given a known “pivot” sample. Say, for instance, that you have a Mirai sample for MIPS, and you want to extract every Mirai variant for any architecture from a dataset of thousands of different unlabeled samples.</p>
<p>The algorithm, that I implemented inside the <a target="_blank" rel="noopener" href="https://github.com/evilsocket/sum">sum database</a> as the <code>findSimilar</code> <em>“oracle”</em> (a fancy name for <em>stored procedure</em>), is quite simple:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Given the vector with id=&quot;id&quot;, return a list of</span></span><br><span class="line"><span class="comment">// other vectors which cosine similarity to the reference</span></span><br><span class="line"><span class="comment">// one is greater or equal than the threshold.</span></span><br><span class="line"><span class="comment">// Results are given as a dictionary of :</span></span><br><span class="line"><span class="comment">//      &quot;vector_id =&gt; similarity&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findSimilar</span>(<span class="params">id, threshold</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> v = records.Find(id);</span><br><span class="line">    <span class="keyword">if</span>( v.IsNull() == <span class="literal">true</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.Error(<span class="string">&quot;Vector &quot;</span> + id + <span class="string">&quot; not found.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> results = &#123;&#125;;</span><br><span class="line">    records.AllBut(v).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">record</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> similarity = v.Cosine(record);</span><br><span class="line">        <span class="keyword">if</span>( similarity &gt;= threshold ) &#123;</span><br><span class="line">           results[record.ID] = similarity</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Yet quite effective:</p>
<img src="https://raw.githubusercontent.com/evilsocket/sum/master/malware_elf.png">

<h3 id="ANN-as-a-black-box-and-Training"><a href="#ANN-as-a-black-box-and-Training" class="headerlink" title="ANN as a black box and Training"></a>ANN as a black box and Training</h3><p>Meanwhile, our encoder should have finished doing its job and the resulting <code>dataset.csv</code> file containing all the labeled vectors extracted from each of the samples should be ready to be used for training our model … but what <em>“training our model”</em> actually means? And what’s this <em>“model”</em> in the first place?</p>
<p>The model we’re using is a computational structure called <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Artificial_neural_network">Artificial neural network</a> that we’re training using the <a target="_blank" rel="noopener" href="https://arxiv.org/abs/1412.6980v8">Adam optimization algorithm</a> . Online you’ll find very detailed and formal definitions of both, but the bottomline is:</p>
<p>An ANN is a “box” containing hundreds of numerical parameters (the <em>“weights”</em> of the “neurons”, organized in layers) that are multiplied with the inputs (our vectors) and combined to produce an output <em>prediction</em>. The training process consists in feeding the system with the dataset, checking the predictions against the known labels, changing those parameters by a small amount, observing if and how those changes affected the model accuracy and repeating this process for a given number of times (<em>epochs</em>) until the overall performance has reached what we defined as the required minimum.</p>
<center>
<img src="https://i.imgur.com/cOwvfAF.png" width="100%">
<small><a href="[https://www.nature.com/articles/s41467-018-06322-x](https://www.nature.com/articles/s41467-018-06322-x)" target="blank">Credits to nature.com</a></small>
</center>

<p>The main assumption is that <em>there is</em> a numerical correlation among the datapoints in our dataset that we don’t know about but that if known would allow us to divide that dataset into the output classes. What we do is asking this blackbox to ingest the dataset and approximate such function by iteratively tweaking its internal parameters.</p>
<p>Inside the <code>model.py</code> file you’ll find the definition of our ANN, a fully connected network with two hidden layers of 70 neurons each, <a target="_blank" rel="noopener" href="https://keras.io/activations/">ReLU</a> as the activation function and a <a target="_blank" rel="noopener" href="https://machinelearningmastery.com/dropout-regularization-deep-learning-models-keras/">dropout</a> of 30% during training:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">n_inputs = <span class="number">486</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Sequential([</span><br><span class="line">    Dense(<span class="number">70</span>, input_shape=(n_inputs,), activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">    Dropout(<span class="number">0.3</span>),</span><br><span class="line">    Dense(<span class="number">70</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">    Dropout(<span class="number">0.3</span>),</span><br><span class="line">    Dense(<span class="number">2</span>, activation=<span class="string">&#x27;softmax&#x27;</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>We can now start the training process with:</p>
<pre><code>ergo train /path/to/ergo-pe-av --dataset /path/to/dataset.csv</code></pre>
<p>Depending on the total amount of vectors in the CSV file, this process might take from a few minutes, to hours, to days. In case you have GPUs on your machine, ergo will automatically use them instead of the CPU cores in order to significantly speed the training up (check <a target="_blank" rel="noopener" href="https://www.datascience.com/blog/cpu-gpu-machine-learning">this article</a> if you’re curious why).</p>
<p>Once done, you can inspect the model performance statistics with:</p>
<pre><code>ergo view /path/to/ergo-pe-av</code></pre>
<p>This will show the training history, where we can verify that the model accuracy indeed increased over time (in our case, it got to a 97% accuracy around epoch 30), and the <a target="_blank" rel="noopener" href="https://towardsdatascience.com/understanding-auc-roc-curve-68b2303cc9c5">ROC curve</a>, which tells us how effectively the model can distinguish between malicious or not (an AUC, or area under the curve, of 0.994, means that the model is pretty good):</p>
<table>
<thead>
<tr>
<th>Training</th>
<th>ROC/AUC</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://raw.githubusercontent.com/evilsocket/ergo-pe-av/master/history.png"></td>
<td><img src="https://raw.githubusercontent.com/evilsocket/ergo-pe-av/master/roc.png"></td>
</tr>
<tr>
<td>Moreover, a confusion matrix for each of the training, validation and test sets will also be shown. The diagonal values from the top left (dark red) represent the number of correct predictions,  while the other values (pink) are the wrong ones (our model has a 1.4% false positives rate on a test set of ~30000 samples):</td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Training</th>
<th>Validation</th>
<th>Testing</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://raw.githubusercontent.com/evilsocket/ergo-pe-av/master/training_cm.png"></td>
<td><img src="https://raw.githubusercontent.com/evilsocket/ergo-pe-av/master/validation_cm.png"></td>
<td><img src="https://raw.githubusercontent.com/evilsocket/ergo-pe-av/master/test_cm.png"></td>
</tr>
</tbody></table>
<p>97% accuracy on such a big dataset is a very interesting result considering how simple our features extraction algorithm is. Many of the misdetections are caused by packers such as UPX (or even just self extracting zip/msi archives) that affect some of the datapoints we’re encoding - adding an unpacking strategy (such as emulating the unpacking stub until the real PE is in memory) and more features (bigger entrypoint vector, dynamic analysis to trace the API being called, imagination is the limit!) is the key to get it to 99% :)</p>
<h3 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h3><p>We can now remove the temporary files:</p>
<pre><code>ergo clean /path/to/ergo-pe-av</code></pre>
<p>Load the model and use it as an API:</p>
<pre><code>ergo serve /path/to/ergo-pe-av --classes &quot;clean, malicious&quot;</code></pre>
<p>And request its classification from a client:</p>
<pre><code>curl -F &quot;x=@/path/to/file.exe&quot; &quot;http://localhost:8080/&quot;</code></pre>
<p>You’ll get a response like the following (<a target="_blank" rel="noopener" href="https://www.virustotal.com/gui/file/af66d5db635537de043facf1580f9655fe441f03f82a7503272e32e3d8473af5/detection">here the file being scanned</a>):</p>
<center>
<img src="https://i.imgur.com/KaWLY2g.png" width="100%">
<small>The model detecting a sample as malicious with over 99% confidence.</small>
</center>

<p>Now you can use the model to scan whatever you want, enjoy! :)</p>
<center>
<img src="https://imgs.xkcd.com/comics/machine_learning.png">
</center>

  </div>

  
    <div class="post-tags">
      
        <a href="/tags/ai/" class="tag">#ai</a>
      
        <a href="/tags/ergo/" class="tag">#ergo</a>
      
        <a href="/tags/keras/" class="tag">#keras</a>
      
        <a href="/tags/tensorflow/" class="tag">#tensorflow</a>
      
        <a href="/tags/tf/" class="tag">#tf</a>
      
        <a href="/tags/deep-learning/" class="tag">#deep learning</a>
      
        <a href="/tags/dnn/" class="tag">#dnn</a>
      
        <a href="/tags/machine-learning/" class="tag">#machine learning</a>
      
        <a href="/tags/neural-networks/" class="tag">#neural networks</a>
      
        <a href="/tags/deep-neural-networks/" class="tag">#deep neural networks</a>
      
        <a href="/tags/cuda/" class="tag">#cuda</a>
      
        <a href="/tags/nvidia/" class="tag">#nvidia</a>
      
        <a href="/tags/malware/" class="tag">#malware</a>
      
        <a href="/tags/malware-detection/" class="tag">#malware detection</a>
      
        <a href="/tags/computer-virus/" class="tag">#computer virus</a>
      
        <a href="/tags/windows-pe/" class="tag">#windows pe</a>
      
        <a href="/tags/portable-executable/" class="tag">#portable executable</a>
      
    </div>
  

  <nav class="post-navigation">
    
      <a href="/2019/10/19/Weaponizing-and-Gamifying-AI-for-WiFi-Hacking-Presenting-Pwnagotchi-1-0-0/" class="nav-prev">
        <span class="nav-label">PREVIOUS</span>
        <span class="nav-title">Weaponizing and Gamifying AI for WiFi Hacking: Presenting Pwnagotchi 1.0.0</span>
      </a>
    
    
      <a href="/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/" class="nav-next">
        <span class="nav-label">NEXT</span>
        <span class="nav-title">Pwning WPA/WPA2 Networks With Bettercap and the PMKID Client-Less Attack</span>
      </a>
    
  </nav>
</article>


  


<section class="related-posts">
  <h3 class="related-title">YOU MIGHT ALSO LIKE...</h3>
  <div class="cards-grid cards-grid-related">
    
      

<article class="card card-light">
  <a href="/2025/03/13/How-To-Write-An-Agent/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2025/agent/loop.png')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">How to Write an Agent</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2022/08/15/Process-behaviour-anomaly-detection-using-eBPF-and-unsupervised-learning-Autoencoders/" class="card-link">
    
      <div class="card-image" style="background-image: url('https://i.imgur.com/QEmpeDl.jpg')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Process Behaviour Anomaly Detection Using eBPF and Unsupervised-Learning Autoencoders</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2019/10/19/Weaponizing-and-Gamifying-AI-for-WiFi-Hacking-Presenting-Pwnagotchi-1-0-0/" class="card-link">
    
      <div class="card-image" style="background-image: url('https://i.imgur.com/X68GXrn.png')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Weaponizing and Gamifying AI for WiFi Hacking: Presenting Pwnagotchi 1.0.0</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-light">
  <a href="/2018/11/22/Presenting-project-Ergo-how-to-build-an-airplane-detector-for-satellite-imagery-with-Deep-Learning/" class="card-link">
    
      <div class="card-image" style="background-image: url('https://i.imgur.com/EO9PdNp.jpg')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">Presenting Project Ergo: How to Build an Airplane Detector for Satellite Imagery With Deep Learning</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
  </div>
</section>




  </main>
  
  <footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-social">
      
        
          
            <a href="https://github.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
        
          
            <a href="https://twitter.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
          
        
          
            <a href="http://it.linkedin.com/in/simonemargaritelli/" class="social-link" target="_blank" rel="noopener" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
          
        
          
        
          
            <a href="mailto:evilsocket@gmail.com" class="social-link" aria-label="Email">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </a>
          
        
      
    </div>
    <p class="footer-copyright">
      &copy; 2025 evilsocket. 
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>.
    </p>
  </div>
</footer>

  <!-- Minimal JS - no external dependencies needed -->
<script>
  // Lazy load images
  document.addEventListener('DOMContentLoaded', function() {
    var images = document.querySelectorAll('.card-image[data-bg]');
    images.forEach(function(img) {
      img.style.backgroundImage = 'url(' + img.dataset.bg + ')';
    });
  });
</script>

</body>
</html>
