<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>How to Hook Win32 API With Kernel Patching | evilsocket</title>
<meta name="description" content="This post is about SSDT patching to perform API hooking within the kernel instead of the classic user mode hooking using remote threads and things like that.SSD">


  <link rel="alternate" href="/atom.xml" title="evilsocket" type="application/atom+xml">


<link rel="icon" href="/images/favicon.ico">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="How to Hook Win32 API With Kernel Patching">
<meta property="og:description" content="This post is about SSDT patching to perform API hooking within the kernel instead of the classic user mode hooking using remote threads and things like that.SSD">
<meta property="og:url" content="/2014/02/01/How-to-hook-Win32-API-with-kernel-patching/">
<meta property="og:site_name" content="evilsocket">

  
  
    <meta property="og:image" content="/images/2014/Feb/KeServiceDescriptorTable_export.png">
  


<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="How to Hook Win32 API With Kernel Patching">
<meta name="twitter:description" content="This post is about SSDT patching to perform API hooking within the kernel instead of the classic user mode hooking using remote threads and things like that.SSD">

<!-- Schema.org JSON-LD -->


<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.evilsocket.net/2014/02/01/How-to-hook-Win32-API-with-kernel-patching/"},"headline":"How to Hook Win32 API With Kernel Patching","description":"This post is about SSDT patching to perform API hooking within the kernel instead of the classic user mode hooking using remote threads and things like that.SSD","image":"https://www.evilsocket.net/images/2014/Feb/KeServiceDescriptorTable_export.png","datePublished":"2014-02-01T18:59:55.000Z","dateModified":"2014-02-03T13:25:15.000Z","author":{"@type":"Person","name":"Simone Margaritelli","description":"Italian cybersecurity researcher and open-source developer","url":"https://www.evilsocket.net","sameAs":["https://github.com/evilsocket","https://twitter.com/evilsocket","http://it.linkedin.com/in/simonemargaritelli/"],"jobTitle":"Security Researcher","worksFor":{"@type":"Organization","name":"Independent"}},"publisher":{"@type":"Organization","name":"evilsocket","url":"https://www.evilsocket.net","logo":{"@type":"ImageObject","url":"https://www.evilsocket.net/images/glider.png"}},"keywords":"hooking, hack, ssdt, kernel, win32, obcallbacks, ntoskrnl, cr0, windows internals, kernel security, driver development, rootkit techniques","articleSection":"Technology","inLanguage":"en"}
</script>


<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Styles -->
<link rel="stylesheet" href="/css/style.css">


<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-22026549-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-22026549-1');
</script>


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="post-page">
  <header class="site-header">
  <div class="header-inner">
    <div class="site-branding">
      <a href="/" class="site-logo">
        
          <img src="/images/glider.png" alt="evilsocket" width="50" height="50">
        
        <div class="site-title-group">
          <span class="site-title">evilsocket</span>
          <span class="site-motto">Preoccupied with a single leaf, you won't see the tree. Preoccupied with a single tree... you'll miss the entire forest.</span>
        </div>
      </a>
    </div>
    
    <nav class="site-nav">
      
        <a href="/" class="nav-link">
          HOME
        </a>
      
        <a href="/atom.xml" class="nav-link">
          RSS
        </a>
      
    </nav>
  </div>
</header>

  
  <main class="main-content">
    <article class="post-full">
  <header class="post-header">
    <h1 class="post-title">How to Hook Win32 API With Kernel Patching</h1>
    <div class="post-meta">
      BY <span class="post-author">Simone Margaritelli</span>
      — <time datetime="2014-02-01T18:59:55.000Z">1 Feb 2014</time>
      
        — <a href="/tags/hooking/" class="post-category">hooking</a>, <a href="/tags/hack/" class="post-category">hack</a>, <a href="/tags/ssdt/" class="post-category">ssdt</a>, <a href="/tags/kernel/" class="post-category">kernel</a>, <a href="/tags/win32/" class="post-category">win32</a>, <a href="/tags/obcallbacks/" class="post-category">obcallbacks</a>, <a href="/tags/ntoskrnl/" class="post-category">ntoskrnl</a>, <a href="/tags/cr0/" class="post-category">cr0</a>, <a href="/tags/windows-internals/" class="post-category">windows internals</a>, <a href="/tags/kernel-security/" class="post-category">kernel security</a>, <a href="/tags/driver-development/" class="post-category">driver development</a>, <a href="/tags/rootkit-techniques/" class="post-category">rootkit techniques</a>
      
    </div>
  </header>

  <div class="post-content">
    <p>This post is about <strong>SSDT</strong> patching to perform API hooking within the kernel instead of the classic user mode hooking using remote threads and things like that.<br>SSDT hooking is as far as I know the lowest level technique to replace/hook/intercept/whatever API and for this reason has been used for years both by malwares writers and AV vendors.<br>I’m using the past tence due to the fact that on 2005 Microsoft introduced a Kernel Patching Protection ( also known as “PatchGuard” ) for 64 bit systems, making this technique uneffective in the worst case or quite harder to perform in the average case.</p>
<span id="more"></span>

<p>If you open the file <strong>ntoskrnl.exe</strong> ( located in the System32/SysWOW64 folder ) with your preferred disassembler, you will noticed a <strong>KeServiceDescriptorTable</strong> symbol being exported:</p>
<p><img src="/images/2014/Feb/KeServiceDescriptorTable_export.png" alt="KeServiceDescriptorTable"></p>
<p>It’s a pointer to a kernel structure defined as</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">SystemServiceDescriptorTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PULONG ServiceTableBase;</span><br><span class="line">  PULONG ServiceCounterTableBase;</span><br><span class="line">  ULONG NumberOfServices;</span><br><span class="line">  PUCHAR ParamTableBase;</span><br><span class="line">&#125;SSDT,*PSSDT;</span><br></pre></td></tr></table></figure>

<p>It works as a big lookup table of Windows Native System Services, a list of kernel API such as NtTerminateProcess, NtLoadDriver, etc.</p>
<p>As you might correctly guess, if it’s exported it can be read and afterwards modified by a kernel driver with some hacks to temporary disable writing protection.</p>
<p>Starting from the address <strong>ServiceTableBase</strong>, each routine can be translated to its service index by the following formula:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*(PULONG)((PUCHAR)Api+<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>For instance, if we wanted to obtain the service index for <strong>ZwTerminateProcess</strong>, we would do:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ULONG ulZwTerminateProcessNumber = (*(PULONG)((PUCHAR)ZwTerminateProcess+<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>( This would suggest that every kernel service routine has its own service number stored in 4 bytes after the first byte of its opcodes )</p>
<p>Once we have the correct service number for the API we want to hook, we can replace it in the descriptor table disabling write protection with the CR0 cpu register, setting the new routine address and then restoring CR0 protection.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(*NtTerminateProcess_T)</span><span class="params">(HANDLE,NTSTATUS)</span></span>;</span><br><span class="line"></span><br><span class="line">ULONG ulZwTerminateProcessNumber = (*(PULONG)((PUCHAR)ZwTerminateProcess+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// disable write protection</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  mov eax,cr0</span><br><span class="line">  <span class="keyword">and</span> eax,<span class="keyword">not</span> <span class="number">0x10000</span></span><br><span class="line">  mov cr0,eax</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// store the original address to restore it on driver unloading</span></span><br><span class="line">NtTerminateProcess_T fnOriginalNtTerminateProcess = (NtTerminateProcess_T)*(PULONG)(ULONG)KeServiceDescriptorTable-&gt;ServiceTableBase + ulZwTerminateProcessNumber * <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// finally patch the table with our own function</span></span><br><span class="line">*((PULONG)ulZwTerminateProcessNumber) = (ULONG)OurNtTerminateProcessHook;</span><br><span class="line"></span><br><span class="line"><span class="comment">// restore write protection</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  mov eax,cr0</span><br><span class="line">  <span class="keyword">or</span> eax,<span class="number">0x10000</span></span><br><span class="line">  mov cr0,eax</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see we store the original function pointer, this is important since once the driver will start the unloading process, we need it to restore the original API address before closing. Forgetting about this step would lead to unpredictable behaviour ( almost surely a BSOD ) since the kernel would call an address that it’s not mapped anymore or that it’s being used by something else.</p>
<p>This is a short overview of this old but effective technique, which was used to protect processes from being killed hooking <strong>NtTerminateProcess</strong> for instance and filtering by PID.<br>Since PatchGuard has been introduced, SSDT hooking became hard to perform therefore Microsoft released a whole new set of <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff558692(v=vs.85).aspx">kernel callbacks</a> for newer systems, I will talk about this on another post.</p>
<p>The full source code for SSDT patching can be found <a target="_blank" rel="noopener" href="http://www.emoticode.net/c/ssdt-hook-driver-with-process-protection.html">here</a>, tnx to <strong>zwclose7</strong> from rohitab for the source code.</p>

  </div>

  
    <div class="post-tags">
      
        <a href="/tags/hooking/" class="tag">#hooking</a>
      
        <a href="/tags/hack/" class="tag">#hack</a>
      
        <a href="/tags/ssdt/" class="tag">#ssdt</a>
      
        <a href="/tags/kernel/" class="tag">#kernel</a>
      
        <a href="/tags/win32/" class="tag">#win32</a>
      
        <a href="/tags/obcallbacks/" class="tag">#obcallbacks</a>
      
        <a href="/tags/ntoskrnl/" class="tag">#ntoskrnl</a>
      
        <a href="/tags/cr0/" class="tag">#cr0</a>
      
        <a href="/tags/windows-internals/" class="tag">#windows internals</a>
      
        <a href="/tags/kernel-security/" class="tag">#kernel security</a>
      
        <a href="/tags/driver-development/" class="tag">#driver development</a>
      
        <a href="/tags/rootkit-techniques/" class="tag">#rootkit techniques</a>
      
    </div>
  

  <nav class="post-navigation">
    
      <a href="/2014/02/02/Process-introspection-for-fun-and-profit/" class="nav-prev">
        <span class="nav-label">PREVIOUS</span>
        <span class="nav-title">Process Introspection for Fun and Profit</span>
      </a>
    
    
  </nav>
</article>


  


<section class="related-posts">
  <h3 class="related-title">YOU MIGHT ALSO LIKE...</h3>
  <div class="cards-grid cards-grid-related">
    
      

<article class="card card-light">
  <a href="/2016/10/09/IoCOFFEE-Reversing-the-Smarter-Coffee-IoT-machine-protocol-to-make-coffee-using-terminal/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2016/10/terminal.png')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">Reversing the Smarter Coffee IoT Machine Protocol to Make Coffee Using the Terminal.</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2016/01/18/Autopwn-every-Android-4-2-device-on-your-network-using-BetterCap-and-the-addJavascriptInterface-vulnerability/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2016/01/hacked.jpg')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Autopwn Every Android &lt; 4.2 Device on Your Network Using BetterCap and the addJavascriptInterface Vulnerability.</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2015/05/04/Android-Native-API-Hooking-with-Library-Injection-and-ELF-Introspection/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/default-cover.svg')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Android Native API Hooking With Library Injection and ELF Introspection.</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-light">
  <a href="/2015/05/02/Using-ARM-Inline-Assembly-and-Naked-Functions-to-fool-Disassemblers/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2015/05/hopper.png')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">Using ARM Inline Assembly and Naked Functions to Fool Disassemblers</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
  </div>
</section>




  </main>
  
  <footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-social">
      
        
          
            <a href="https://github.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
        
          
            <a href="https://twitter.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
          
        
          
            <a href="http://it.linkedin.com/in/simonemargaritelli/" class="social-link" target="_blank" rel="noopener" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
          
        
          
        
          
            <a href="mailto:evilsocket@gmail.com" class="social-link" aria-label="Email">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </a>
          
        
      
    </div>
    <p class="footer-copyright">
      &copy; 2025 evilsocket. 
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>.
    </p>
  </div>
</footer>

  <!-- Minimal JS - no external dependencies needed -->
<script>
  // Lazy load images
  document.addEventListener('DOMContentLoaded', function() {
    var images = document.querySelectorAll('.card-image[data-bg]');
    images.forEach(function(img) {
      img.style.backgroundImage = 'url(' + img.dataset.bg + ')';
    });
  });
</script>

</body>
</html>
