<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.I came accross the PEB ( process">
<meta property="og:type" content="article">
<meta property="og:title" content="Process Introspection for Fun and Profit">
<meta property="og:url" content="https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/index.html">
<meta property="og:site_name" content="evilsocket">
<meta property="og:description" content="While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.I came accross the PEB ( process">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2014-02-02T02:17:24.000Z">
<meta property="article:modified_time" content="2014-02-03T13:26:14.000Z">
<meta property="article:author" content="Simone Margaritelli">
<meta property="article:tag" content="hooking">
<meta property="article:tag" content="api hooking">
<meta property="article:tag" content="emulator">
<meta property="article:tag" content="malware">
<meta property="article:tag" content="win32">
<meta property="article:tag" content="tib">
<meta property="article:tag" content="process environment block">
<meta property="article:tag" content="ldr">
<meta property="article:tag" content="loader">
<meta property="article:tag" content="pe">
<meta property="article:tag" content="vm">
<meta property="article:tag" content="evasion">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
          
        
    
    <!-- title -->
    <title>Process Introspection for Fun and Profit</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="evilsocket" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">~/</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2014/02/05/Termination-and-injection-self-defense-on-Windows-Vista-SP1/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2014/02/01/How-to-hook-Win32-API-with-kernel-patching/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&text=Process Introspection for Fun and Profit"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&is_video=false&description=Process Introspection for Fun and Profit"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Process Introspection for Fun and Profit&body=Check out this article: https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&name=Process Introspection for Fun and Profit&description=&lt;p&gt;While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.&lt;br&gt;I came accross the &lt;strong&gt;PEB&lt;/strong&gt; ( process environment block ), a data structure ( mostly undocumented ) that NT systems use internally to handle many aspects of a process, including a list of loaded libraries, environment variables, command line arguments, heap informations, TLS slots and so on.&lt;br&gt;The interesting fact about the PEB is that can be inspected to obtain those informations without the use of any standard API, thus resulting in an interesting technique to detect bad written virtual machines, emulators and any sort of sandboxing that could be used by a malware analyst or an anti virus product.&lt;br&gt;Moreover you could check the PEB to detect if a DLL has been injected into your process to perform api hooking.&lt;br&gt;API hooking softwares usually hooks API such as &lt;strong&gt;EnumProcessModules&lt;/strong&gt; and patch them to hide the presence of the injected module. Inspecting the PEB you will be able to perform the same task only analyzing your address space, thus avoiding API patching.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline" style="text-transform: uppercase;">
        Process Introspection for Fun and Profit
    </h1>
    <br/>



      <div class="meta">
        
    <div class="postdate">
        <time datetime="2014-02-02T02:17:24.000Z" itemprop="datePublished">2014-02-02</time>
    </div>


          
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/api-hooking/" rel="tag">api hooking</a>, <a class="tag-link-link" href="/tags/emulator/" rel="tag">emulator</a>, <a class="tag-link-link" href="/tags/evasion/" rel="tag">evasion</a>, <a class="tag-link-link" href="/tags/hooking/" rel="tag">hooking</a>, <a class="tag-link-link" href="/tags/ldr/" rel="tag">ldr</a>, <a class="tag-link-link" href="/tags/loader/" rel="tag">loader</a>, <a class="tag-link-link" href="/tags/malware/" rel="tag">malware</a>, <a class="tag-link-link" href="/tags/pe/" rel="tag">pe</a>, <a class="tag-link-link" href="/tags/process-environment-block/" rel="tag">process environment block</a>, <a class="tag-link-link" href="/tags/tib/" rel="tag">tib</a>, <a class="tag-link-link" href="/tags/vm/" rel="tag">vm</a>, <a class="tag-link-link" href="/tags/win32/" rel="tag">win32</a>
    </div>


      </div>
  </header>

  <br />
  

    <div class="content" itemprop="articleBody">
      <p>While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.<br>I came accross the <strong>PEB</strong> ( process environment block ), a data structure ( mostly undocumented ) that NT systems use internally to handle many aspects of a process, including a list of loaded libraries, environment variables, command line arguments, heap informations, TLS slots and so on.<br>The interesting fact about the PEB is that can be inspected to obtain those informations without the use of any standard API, thus resulting in an interesting technique to detect bad written virtual machines, emulators and any sort of sandboxing that could be used by a malware analyst or an anti virus product.<br>Moreover you could check the PEB to detect if a DLL has been injected into your process to perform api hooking.<br>API hooking softwares usually hooks API such as <strong>EnumProcessModules</strong> and patch them to hide the presence of the injected module. Inspecting the PEB you will be able to perform the same task only analyzing your address space, thus avoiding API patching.</p>
<span id="more"></span>

<p>The address of the structure in our process virtual memory can be obtained with the <strong>NtQueryInformationProcess</strong> API, once you have the address you can cast it to a pointer to the following type.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  BYTE                    InheritedAddressSpace;</span><br><span class="line">  BYTE                    ReadImageFileExecOptions;</span><br><span class="line">  BYTE                    BeingDebugged;</span><br><span class="line">  BYTE                    Spare;</span><br><span class="line">  DWORD                   dwMutant;                              </span><br><span class="line">  DWORD                   dwImageBaseAddress;                                                      </span><br><span class="line">  PEB_LDR_DATA*           LoaderData;                                                                      </span><br><span class="line">  DWORD                   dwProcessParameters;                                                </span><br><span class="line">  DWORD                   dwSubSystemData;                     </span><br><span class="line">  DWORD                   dwProcessHeap;                       </span><br><span class="line">  DWORD                   dwFastPebLock;                       </span><br><span class="line">  DWORD                   dwFastPebLockRoutine;                </span><br><span class="line">  DWORD                   dwFastPebUnlockRoutine;              </span><br><span class="line">  DWORD                   dwEnvironmentUpdateCount;            </span><br><span class="line">  DWORD                   dwKernelCallbackTable;               </span><br><span class="line">  DWORD                   dwEventLogSection;                   </span><br><span class="line">  DWORD                   dwEventLog;                          </span><br><span class="line">  DWORD                   dwFreeList;                          </span><br><span class="line">  DWORD                   dwTlsExpansionCounter;               </span><br><span class="line">  DWORD                   dwTlsBitmap;                         </span><br><span class="line">  DWORD                   dwTlsBitmapBits[<span class="number">0x2</span>];</span><br><span class="line">  DWORD                   dwReadOnlySharedMemoryBase;</span><br><span class="line">  DWORD                   dwReadOnlySharedMemoryHeap;</span><br><span class="line">  DWORD                   dwReadOnlyStaticServerData;</span><br><span class="line">  DWORD                   dwAnsiCodePageData;</span><br><span class="line">  DWORD                   dwOemCodePageData;</span><br><span class="line">  DWORD                   dwUnicodeCaseTableData;</span><br><span class="line">  DWORD                   dwNumberOfProcessors;</span><br><span class="line">  DWORD                   dwNtGlobalFlag;</span><br><span class="line">  DWORD                   dwSpare2;</span><br><span class="line">  DWORD                   dwCriticalSectionTimeout1;</span><br><span class="line">  DWORD                   dwCriticalSectionTimeout2;</span><br><span class="line">  DWORD                   dwHeapSegmentReserve;</span><br><span class="line">  DWORD                   dwHeapSegmentCommit;</span><br><span class="line">  DWORD                   dwHeapDeCommitTotalFreeThreshold;</span><br><span class="line">  DWORD                   dwHeapDeCommitFreeBlockThreshold;</span><br><span class="line">  DWORD                   dwNumberOfHeaps;                              </span><br><span class="line">  DWORD                   dwMaximumNumberOfHeaps;                        </span><br><span class="line">  DWORD                   *ProcessHeaps;                               </span><br><span class="line">  DWORD                   dwGdiSharedHandleTable;</span><br><span class="line">  DWORD                   dwProcessStarterHelper;</span><br><span class="line">  DWORD                   dwGdiDCAttributeList;</span><br><span class="line">  DWORD                   dwLoaderLock;</span><br><span class="line">  DWORD                   dwOSMajorVersion;</span><br><span class="line">  DWORD                   dwOSMinorVersion;</span><br><span class="line">  DWORD                   dwOSBuildNumber;</span><br><span class="line">  DWORD                   dwOSPlatformId;</span><br><span class="line">  DWORD                   dwImageSubSystem;</span><br><span class="line">  DWORD                   dwImageSubSystemMajorVersion;</span><br><span class="line">  DWORD                   dwImageSubSystemMinorVersion;</span><br><span class="line">  DWORD                   GdiHandleBuffer[<span class="number">0x22</span>];</span><br><span class="line">  DWORD                   dwPostProcessInitRoutine;</span><br><span class="line">  DWORD                   dwTlsExpansionBitmap;</span><br><span class="line">  BYTE                    TlsExpansionBitmapBits[<span class="number">0x80</span>];</span><br><span class="line">  DWORD                   dwSessionId;</span><br><span class="line">&#125;</span><br><span class="line">PEB;</span><br></pre></td></tr></table></figure>

<p>As you can see there’s a lot that can be tested to evade sandboxing software due to the fact that most of them won’t emulate a correct PEB, the following source code will demonstrate how to read it and print many informations about the process.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PROCESS_BASIC_INFORMATION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PVOID Reserved1;</span><br><span class="line">  PVOID PebBaseAddress;</span><br><span class="line">  PVOID Reserved2[<span class="number">2</span>];</span><br><span class="line">  ULONG_PTR UniqueProcessId;</span><br><span class="line">  PVOID Reserved3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  BYTE       Reserved1[<span class="number">8</span>];</span><br><span class="line">  PVOID      Reserved2[<span class="number">3</span>];</span><br><span class="line">  LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">&#125;</span><br><span class="line">PEB_LDR_DATA ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TIB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PEXCEPTION_REGISTRATION_RECORD* ExceptionList; <span class="comment">// FS:0x00</span></span><br><span class="line">  DWORD dwStackBase;                             <span class="comment">// FS:0x04</span></span><br><span class="line">  DWORD dwStackLimit;                            <span class="comment">// FS:0x08</span></span><br><span class="line">  DWORD dwSubSystemTib;                          <span class="comment">// FS:0x0C</span></span><br><span class="line">  DWORD dwFiberData;                             <span class="comment">// FS:0x10</span></span><br><span class="line">  DWORD dwArbitraryUserPointer;                  <span class="comment">// FS:0x14</span></span><br><span class="line">  DWORD dwTIBOffset;                             <span class="comment">// FS:0x18</span></span><br><span class="line">&#125;</span><br><span class="line">TIB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  BYTE                    InheritedAddressSpace;</span><br><span class="line">  BYTE                    ReadImageFileExecOptions;</span><br><span class="line">  BYTE                    BeingDebugged;</span><br><span class="line">  BYTE                    Spare;</span><br><span class="line">  DWORD                   dwMutant;                              </span><br><span class="line">  DWORD                   dwImageBaseAddress;                                                      </span><br><span class="line">  PEB_LDR_DATA*           LoaderData;                                                                      </span><br><span class="line">  DWORD                   dwProcessParameters;                                                </span><br><span class="line">  DWORD                   dwSubSystemData;                     </span><br><span class="line">  DWORD                   dwProcessHeap;                       </span><br><span class="line">  DWORD                   dwFastPebLock;                       </span><br><span class="line">  DWORD                   dwFastPebLockRoutine;                </span><br><span class="line">  DWORD                   dwFastPebUnlockRoutine;              </span><br><span class="line">  DWORD                   dwEnvironmentUpdateCount;            </span><br><span class="line">  DWORD                   dwKernelCallbackTable;               </span><br><span class="line">  DWORD                   dwEventLogSection;                   </span><br><span class="line">  DWORD                   dwEventLog;                          </span><br><span class="line">  DWORD                   dwFreeList;                          </span><br><span class="line">  DWORD                   dwTlsExpansionCounter;               </span><br><span class="line">  DWORD                   dwTlsBitmap;                         </span><br><span class="line">  DWORD                   dwTlsBitmapBits[<span class="number">0x2</span>];</span><br><span class="line">  DWORD                   dwReadOnlySharedMemoryBase;</span><br><span class="line">  DWORD                   dwReadOnlySharedMemoryHeap;</span><br><span class="line">  DWORD                   dwReadOnlyStaticServerData;</span><br><span class="line">  DWORD                   dwAnsiCodePageData;</span><br><span class="line">  DWORD                   dwOemCodePageData;</span><br><span class="line">  DWORD                   dwUnicodeCaseTableData;</span><br><span class="line">  DWORD                   dwNumberOfProcessors;</span><br><span class="line">  DWORD                   dwNtGlobalFlag;</span><br><span class="line">  DWORD                   dwSpare2;</span><br><span class="line">  DWORD                   dwCriticalSectionTimeout1;</span><br><span class="line">  DWORD                   dwCriticalSectionTimeout2;</span><br><span class="line">  DWORD                   dwHeapSegmentReserve;</span><br><span class="line">  DWORD                   dwHeapSegmentCommit;</span><br><span class="line">  DWORD                   dwHeapDeCommitTotalFreeThreshold;</span><br><span class="line">  DWORD                   dwHeapDeCommitFreeBlockThreshold;</span><br><span class="line">  DWORD                   dwNumberOfHeaps;                              </span><br><span class="line">  DWORD                   dwMaximumNumberOfHeaps;                        </span><br><span class="line">  DWORD                   *ProcessHeaps;                               </span><br><span class="line">  DWORD                   dwGdiSharedHandleTable;</span><br><span class="line">  DWORD                   dwProcessStarterHelper;</span><br><span class="line">  DWORD                   dwGdiDCAttributeList;</span><br><span class="line">  DWORD                   dwLoaderLock;</span><br><span class="line">  DWORD                   dwOSMajorVersion;</span><br><span class="line">  DWORD                   dwOSMinorVersion;</span><br><span class="line">  DWORD                   dwOSBuildNumber;</span><br><span class="line">  DWORD                   dwOSPlatformId;</span><br><span class="line">  DWORD                   dwImageSubSystem;</span><br><span class="line">  DWORD                   dwImageSubSystemMajorVersion;</span><br><span class="line">  DWORD                   dwImageSubSystemMinorVersion;</span><br><span class="line">  DWORD                   GdiHandleBuffer[<span class="number">0x22</span>];</span><br><span class="line">  DWORD                   dwPostProcessInitRoutine;</span><br><span class="line">  DWORD                   dwTlsExpansionBitmap;</span><br><span class="line">  BYTE                    TlsExpansionBitmapBits[<span class="number">0x80</span>];</span><br><span class="line">  DWORD                   dwSessionId;</span><br><span class="line">&#125;</span><br><span class="line">PEB;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UNICODE_STRING</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  USHORT Length;</span><br><span class="line">  USHORT MaximumLength;</span><br><span class="line">  PWSTR  Buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LDR_MODULE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  LIST_ENTRY              InLoadOrderModuleList;</span><br><span class="line">  LIST_ENTRY              InMemoryOrderModuleList;</span><br><span class="line">  LIST_ENTRY              InInitializationOrderModuleList;</span><br><span class="line">  PVOID                   BaseAddress;</span><br><span class="line">  PVOID                   EntryPoint;</span><br><span class="line">  ULONG                   SizeOfImage;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">UNICODE_STRING</span>  <span class="title">FullDllName</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">UNICODE_STRING</span>  <span class="title">BaseDllName</span>;</span></span><br><span class="line">  ULONG                   Flags;</span><br><span class="line">  SHORT                   LoadCount;</span><br><span class="line">  SHORT                   TlsIndex;</span><br><span class="line">  LIST_ENTRY              HashTableEntry;</span><br><span class="line">  ULONG                   TimeDateStamp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">PROCESSINFOCLASS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ProcessBasicInformation = <span class="number">0</span>,</span><br><span class="line">  ProcessDebugPort = <span class="number">7</span>,</span><br><span class="line">  ProcessWow64Information = <span class="number">26</span>,</span><br><span class="line">  ProcessImageFileName = <span class="number">27</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span> <span class="params">(*NtQueryInformationProcess_T)</span><span class="params">( HANDLE, <span class="keyword">enum</span> PROCESSINFOCLASS, PVOID, ULONG, PULONG )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HMODULE hNtdll;</span><br><span class="line">  NTSTATUS status;</span><br><span class="line">  ULONG bytesReturned;</span><br><span class="line">  PLIST_ENTRY lEntry;</span><br><span class="line">  NtQueryInformationProcess_T pfnNtQueryInformationProcess;</span><br><span class="line">  DWORD dwTIB;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">PROCESS_BASIC_INFORMATION</span> <span class="title">basicInfo</span>;</span></span><br><span class="line">  PEB* peb;</span><br><span class="line">  TIB *tib;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">LDR_MODULE</span> *<span class="title">pLdrModule</span>;</span></span><br><span class="line"></span><br><span class="line">  hNtdll = LoadLibrary(<span class="string">L&quot;ntdll.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">  pfnNtQueryInformationProcess = (NtQueryInformationProcess_T)GetProcAddress(hNtdll, <span class="string">&quot;NtQueryInformationProcess&quot;</span> );</span><br><span class="line"></span><br><span class="line">  assert(pfnNtQueryInformationProcess != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  status = pfnNtQueryInformationProcess( GetCurrentProcess(), ProcessBasicInformation, &amp;basicInfo, <span class="keyword">sizeof</span>(basicInfo), &amp;bytesReturned );</span><br><span class="line"></span><br><span class="line">  assert(status == <span class="number">0</span> &amp;&amp; bytesReturned == <span class="keyword">sizeof</span>(basicInfo));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get our TIB address ( same as mov eax, fs:0x18 )</span></span><br><span class="line">  dwTIB = __readfsdword(<span class="number">0x18</span>);</span><br><span class="line">  tib = (TIB *)dwTIB;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get our PEB address</span></span><br><span class="line">  peb = (PEB *)basicInfo.PebBaseAddress;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.ExceptionList          : %08X\n&quot;</span>, tib-&gt;ExceptionList );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.dwStackBase            : %08X\n&quot;</span>, tib-&gt;dwStackBase );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.dwStackLimit           : %08X\n&quot;</span>, tib-&gt;dwStackLimit );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.dwSubSystemTib         : %08X\n&quot;</span>, tib-&gt;dwSubSystemTib );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.dwFiberData            : %08X\n&quot;</span>, tib-&gt;dwFiberData );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.dwArbitraryUserPointer : %08X\n&quot;</span>, tib-&gt;dwArbitraryUserPointer );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;TIB.dwTIBOffset            : %08X\n&quot;</span>, tib-&gt;dwTIBOffset );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.InheritedAddressSpace : %08X\n&quot;</span>, peb-&gt;InheritedAddressSpace );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.ReadImageFileExecOptions : %08X\n&quot;</span>, peb-&gt;ReadImageFileExecOptions );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.BeingDebugged : %08X\n&quot;</span>, peb-&gt;BeingDebugged );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.Spare : %08X\n&quot;</span>, peb-&gt;Spare );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwMutant : %08X\n&quot;</span>, peb-&gt;dwMutant );                              </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwImageBaseAddress : %08X\n&quot;</span>, peb-&gt;dwImageBaseAddress );                                                      </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.LoaderData : %08X\n&quot;</span>, peb-&gt;LoaderData );                                                                      </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwProcessParameters : %08X\n&quot;</span>, peb-&gt;dwProcessParameters );                                                </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwSubSystemData : %08X\n&quot;</span>, peb-&gt;dwSubSystemData );                     </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwProcessHeap : %08X\n&quot;</span>, peb-&gt;dwProcessHeap );                       </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwFastPebLock : %08X\n&quot;</span>, peb-&gt;dwFastPebLock );                       </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwFastPebLockRoutine : %08X\n&quot;</span>, peb-&gt;dwFastPebLockRoutine );                </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwFastPebUnlockRoutine : %08X\n&quot;</span>, peb-&gt;dwFastPebUnlockRoutine );              </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwEnvironmentUpdateCount : %08X\n&quot;</span>, peb-&gt;dwEnvironmentUpdateCount );            </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwKernelCallbackTable : %08X\n&quot;</span>, peb-&gt;dwKernelCallbackTable );               </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwEventLogSection : %08X\n&quot;</span>, peb-&gt;dwEventLogSection );                   </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwEventLog : %08X\n&quot;</span>, peb-&gt;dwEventLog );                          </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwFreeList : %08X\n&quot;</span>, peb-&gt;dwFreeList );                          </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwTlsExpansionCounter : %08X\n&quot;</span>, peb-&gt;dwTlsExpansionCounter );               </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwTlsBitmap : %08X\n&quot;</span>, peb-&gt;dwTlsBitmap );                         </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwReadOnlySharedMemoryBase : %08X\n&quot;</span>, peb-&gt;dwReadOnlySharedMemoryBase );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwReadOnlySharedMemoryHeap : %08X\n&quot;</span>, peb-&gt;dwReadOnlySharedMemoryHeap );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwReadOnlyStaticServerData : %08X\n&quot;</span>, peb-&gt;dwReadOnlyStaticServerData );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwAnsiCodePageData : %08X\n&quot;</span>, peb-&gt;dwAnsiCodePageData );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwOemCodePageData : %08X\n&quot;</span>, peb-&gt;dwOemCodePageData );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwUnicodeCaseTableData : %08X\n&quot;</span>, peb-&gt;dwUnicodeCaseTableData );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwNumberOfProcessors : %08X\n&quot;</span>, peb-&gt;dwNumberOfProcessors );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwNtGlobalFlag : %08X\n&quot;</span>, peb-&gt;dwNtGlobalFlag );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwSpare2 : %08X\n&quot;</span>, peb-&gt;dwSpare2 );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwCriticalSectionTimeout1 : %08X\n&quot;</span>, peb-&gt;dwCriticalSectionTimeout1 );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwCriticalSectionTimeout2 : %08X\n&quot;</span>, peb-&gt;dwCriticalSectionTimeout2 );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwHeapSegmentReserve : %08X\n&quot;</span>, peb-&gt;dwHeapSegmentReserve );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwHeapSegmentCommit : %08X\n&quot;</span>, peb-&gt;dwHeapSegmentCommit );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwHeapDeCommitTotalFreeThreshold : %08X\n&quot;</span>, peb-&gt;dwHeapDeCommitTotalFreeThreshold );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwHeapDeCommitFreeBlockThreshold : %08X\n&quot;</span>, peb-&gt;dwHeapDeCommitFreeBlockThreshold );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwNumberOfHeaps : %08X\n&quot;</span>, peb-&gt;dwNumberOfHeaps );                              </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwMaximumNumberOfHeaps : %08X\n&quot;</span>, peb-&gt;dwMaximumNumberOfHeaps );                        </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.*ProcessHeaps : %08X\n&quot;</span>, peb-&gt;ProcessHeaps );                               </span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwGdiSharedHandleTable : %08X\n&quot;</span>, peb-&gt;dwGdiSharedHandleTable );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwProcessStarterHelper : %08X\n&quot;</span>, peb-&gt;dwProcessStarterHelper );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwGdiDCAttributeList : %08X\n&quot;</span>, peb-&gt;dwGdiDCAttributeList );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwLoaderLock : %08X\n&quot;</span>, peb-&gt;dwLoaderLock );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwOSMajorVersion : %08X\n&quot;</span>, peb-&gt;dwOSMajorVersion );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwOSMinorVersion : %08X\n&quot;</span>, peb-&gt;dwOSMinorVersion );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwOSBuildNumber : %08X\n&quot;</span>, peb-&gt;dwOSBuildNumber );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwOSPlatformId : %08X\n&quot;</span>, peb-&gt;dwOSPlatformId );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwImageSubSystem : %08X\n&quot;</span>, peb-&gt;dwImageSubSystem );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwImageSubSystemMajorVersion : %08X\n&quot;</span>, peb-&gt;dwImageSubSystemMajorVersion );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwImageSubSystemMinorVersion : %08X\n&quot;</span>, peb-&gt;dwImageSubSystemMinorVersion );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwPostProcessInitRoutine : %08X\n&quot;</span>, peb-&gt;dwPostProcessInitRoutine );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwTlsExpansionBitmap : %08X\n&quot;</span>, peb-&gt;dwTlsExpansionBitmap );</span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;PEB.dwSessionId : %08X\n&quot;</span>, peb-&gt;dwSessionId );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>( <span class="string">&quot;\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get the main module</span></span><br><span class="line">  pLdrModule = (struct LDR_MODULE*)peb-&gt;LoaderData-&gt;InMemoryOrderModuleList.Flink;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span></span><br><span class="line">  (</span><br><span class="line">    <span class="string">&quot;%-17S base@ %10p size: %10x flags: %12x\n&quot;</span>,</span><br><span class="line">    pLdrModule-&gt;FullDllName.Buffer,</span><br><span class="line">    pLdrModule-&gt;BaseAddress,</span><br><span class="line">    pLdrModule-&gt;SizeOfImage,</span><br><span class="line">    pLdrModule-&gt;Flags</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop each loaded module</span></span><br><span class="line">  <span class="keyword">for</span>( lEntry = peb-&gt;LoaderData-&gt;InMemoryOrderModuleList.Flink-&gt;Flink; pLdrModule-&gt;BaseAddress != <span class="number">0</span>; lEntry = lEntry-&gt;Flink )</span><br><span class="line">  &#123;</span><br><span class="line">    pLdrModule = (struct LDR_MODULE*)lEntry;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span></span><br><span class="line">    (</span><br><span class="line">      <span class="string">&quot;%-17S base@ %10p size: %10x flags: %12x\n&quot;</span>,</span><br><span class="line">      pLdrModule-&gt;FullDllName.Buffer,</span><br><span class="line">      pLdrModule-&gt;BaseAddress,</span><br><span class="line">      pLdrModule-&gt;SizeOfImage,</span><br><span class="line">      pLdrModule-&gt;Flags</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FreeLibrary( hNtdll );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>


    <p>
      <br /><br /><br />
      <a href="https://discord.gg/btZpkp45gQ" target="_blank" title="Join our community!">
        <img src="https://dcbadge.limes.pink/api/server/https://discord.gg/btZpkp45gQ" />
      </a>
    </p>

</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">~/</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&text=Process Introspection for Fun and Profit"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&is_video=false&description=Process Introspection for Fun and Profit"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Process Introspection for Fun and Profit&body=Check out this article: https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&title=Process Introspection for Fun and Profit"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.evilsocket.net/2014/02/02/Process-introspection-for-fun-and-profit/&name=Process Introspection for Fun and Profit&description=&lt;p&gt;While studying Windows internals for my job, I had to  deepen my knowledge of executable loading process, including their memory layout, address relocations and so on.&lt;br&gt;I came accross the &lt;strong&gt;PEB&lt;/strong&gt; ( process environment block ), a data structure ( mostly undocumented ) that NT systems use internally to handle many aspects of a process, including a list of loaded libraries, environment variables, command line arguments, heap informations, TLS slots and so on.&lt;br&gt;The interesting fact about the PEB is that can be inspected to obtain those informations without the use of any standard API, thus resulting in an interesting technique to detect bad written virtual machines, emulators and any sort of sandboxing that could be used by a malware analyst or an anti virus product.&lt;br&gt;Moreover you could check the PEB to detect if a DLL has been injected into your process to perform api hooking.&lt;br&gt;API hooking softwares usually hooks API such as &lt;strong&gt;EnumProcessModules&lt;/strong&gt; and patch them to hide the presence of the injected module. Inspecting the PEB you will be able to perform the same task only analyzing your address space, thus avoiding API patching.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2024 Simone Margaritelli
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">~/</a></li>
         
          <li><a href="/atom.xml">rss</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-22026549-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'evilsocket';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


