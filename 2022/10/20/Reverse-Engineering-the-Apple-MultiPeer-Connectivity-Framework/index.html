<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Reverse Engineering the Apple MultiPeer Connectivity Framework | evilsocket</title>
<meta name="description" content="Some time ago I was using Logic Pro to record some of my music and I needed a way to start and stop the recording from an iPhone, so I found about Logic Remote ">


  <link rel="alternate" href="/atom.xml" title="evilsocket" type="application/atom+xml">


<link rel="icon" href="/images/favicon.ico">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="Reverse Engineering the Apple MultiPeer Connectivity Framework">
<meta property="og:description" content="Some time ago I was using Logic Pro to record some of my music and I needed a way to start and stop the recording from an iPhone, so I found about Logic Remote ">
<meta property="og:url" content="/2022/10/20/Reverse-Engineering-the-Apple-MultiPeer-Connectivity-Framework/">
<meta property="og:site_name" content="evilsocket">

  
  
    <meta property="og:image" content="/images/2022/cleartext.png">
  


<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Reverse Engineering the Apple MultiPeer Connectivity Framework">
<meta name="twitter:description" content="Some time ago I was using Logic Pro to record some of my music and I needed a way to start and stop the recording from an iPhone, so I found about Logic Remote ">

<!-- Schema.org JSON-LD -->


<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.evilsocket.net/2022/10/20/Reverse-Engineering-the-Apple-MultiPeer-Connectivity-Framework/"},"headline":"Reverse Engineering the Apple MultiPeer Connectivity Framework","description":"Some time ago I was using Logic Pro to record some of my music and I needed a way to start and stop the recording from an iPhone, so I found about Logic Remote ","image":"https://www.evilsocket.net/images/2022/cleartext.png","datePublished":"2022-10-20T11:05:13.000Z","dateModified":"2026-02-03T16:01:03.128Z","author":{"@type":"Person","name":"Simone Margaritelli","description":"Italian cybersecurity researcher, hacker, and open-source developer with over two decades of experience in network security, AI, and offensive security tools.","url":"https://www.evilsocket.net","image":"https://www.evilsocket.net/images/glider.png","sameAs":["https://github.com/evilsocket","https://twitter.com/evilsocket","http://it.linkedin.com/in/simonemargaritelli/","https://www.goodreads.com/evilsocket","https://www.patreon.com/evilsocket","https://keybase.io/evilsocket"],"jobTitle":"Security Researcher","knowsAbout":["Cybersecurity","Penetration Testing","Network Security","Reverse Engineering","Open Source Development","Wireless Security","Machine Learning","Go Programming","Python","C/C++"],"award":["Creator of bettercap","Creator of pwnagotchi","Creator of OpenSnitch","CVE-2024-47176 discoverer"],"worksFor":{"@type":"Organization","name":"Independent"}},"publisher":{"@type":"Organization","name":"evilsocket","url":"https://www.evilsocket.net","logo":{"@type":"ImageObject","url":"https://www.evilsocket.net/images/glider.png"}},"keywords":"re, network, macos security, protocol reversing, apple, reverse engineering, multipeerconnectivity, mpc framework, framework, multipeer, wireshark, network packets, network protocol, tcp, stun, facetime, mcpeer, mcpeerid, mdns, ospf, ice, proprietary protocol, ios","articleSection":"Cybersecurity","inLanguage":"en"}
</script>


<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Styles -->
<link rel="stylesheet" href="/css/style.css">


<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-22026549-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-22026549-1');
</script>


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="post-page">
  <header class="site-header">
  <div class="header-inner">
    <div class="site-branding">
      <a href="/" class="site-logo">
        
          <img src="/images/glider.png" alt="evilsocket" width="50" height="50">
        
        <div class="site-title-group">
          <span class="site-title">evilsocket</span>
          <span class="site-motto">Preoccupied with a single leaf, you won't see the tree. Preoccupied with a single tree... you'll miss the entire forest.</span>
        </div>
      </a>
    </div>
    
    <nav class="site-nav">
      
        <a href="/" class="nav-link">
          HOME
        </a>
      
        <a href="/atom.xml" class="nav-link">
          RSS
        </a>
      
    </nav>
  </div>
</header>

  
  <main class="main-content">
    <article class="post-full">
  <header class="post-header">
    <h1 class="post-title">Reverse Engineering the Apple MultiPeer Connectivity Framework</h1>
    <div class="post-meta">
      BY <span class="post-author">Simone Margaritelli</span>
      — <time datetime="2022-10-20T11:05:13.000Z">20 Oct 2022</time>
      
        — <a href="/tags/re/" class="post-category">re</a>, <a href="/tags/network/" class="post-category">network</a>, <a href="/tags/macos-security/" class="post-category">macos security</a>, <a href="/tags/protocol-reversing/" class="post-category">protocol reversing</a>, <a href="/tags/apple/" class="post-category">apple</a>, <a href="/tags/reverse-engineering/" class="post-category">reverse engineering</a>, <a href="/tags/multipeerconnectivity/" class="post-category">multipeerconnectivity</a>, <a href="/tags/mpc-framework/" class="post-category">mpc framework</a>, <a href="/tags/framework/" class="post-category">framework</a>, <a href="/tags/multipeer/" class="post-category">multipeer</a>, <a href="/tags/wireshark/" class="post-category">wireshark</a>, <a href="/tags/network-packets/" class="post-category">network packets</a>, <a href="/tags/network-protocol/" class="post-category">network protocol</a>, <a href="/tags/tcp/" class="post-category">tcp</a>, <a href="/tags/stun/" class="post-category">stun</a>, <a href="/tags/facetime/" class="post-category">facetime</a>, <a href="/tags/mcpeer/" class="post-category">mcpeer</a>, <a href="/tags/mcpeerid/" class="post-category">mcpeerid</a>, <a href="/tags/mdns/" class="post-category">mdns</a>, <a href="/tags/ospf/" class="post-category">ospf</a>, <a href="/tags/ice/" class="post-category">ice</a>, <a href="/tags/proprietary-protocol/" class="post-category">proprietary protocol</a>, <a href="/tags/ios/" class="post-category">ios</a>
      
    </div>
    <br/>
    <a target="_blank" rel="noopener" href="https://twitter.com/evilsocket" class="twitter-follow-button" data-show-count="false">Follow me on X</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </header>

  <div class="post-content">
    <p>Some time ago I was using <a target="_blank" rel="noopener" href="https://www.apple.com/it/logic-pro/">Logic Pro</a> to record some of my music and I needed a way to start and stop the recording from an iPhone, so I found about <a target="_blank" rel="noopener" href="https://apps.apple.com/it/app/logic-remote/id638394624">Logic Remote</a> and was quite happy with it.<br>After the session, the hacker in me became curious about how the tools were communicating with each other, so I quickly started Wireshark while establishing a connection and saw something that tickled my curiosity even more: some of the data, such as the client and server names, were transmitted in cleartext on what it seemed a custom (and as typical of Apple, undocumented) TCP protocol (<strong>“stevie”</strong> being the hostname of my Mac):</p>
<p><img src="/images/2022/cleartext.png" alt="cleartext packets"></p>
<p>Using <a target="_blank" rel="noopener" href="https://ss64.com/osx/lsof.html">lsof</a> confirmed that this was indeed the communication between the client phone and Logic listening on port 56076:</p>
<p><img src="/images/2022/lsof.png" alt="lsof"></p>
<p>Initially I tought this was just some Logic Pro specific protocol and very lazily started looking into it, without much success mostly due to lack of motivation given the very limited scope of the research. After a while I <a target="_blank" rel="noopener" href="https://twitter.com/evilsocket/status/1568310905640722433">tweeted</a> asking if anyone had ever seen anything like it. <a target="_blank" rel="noopener" href="https://twitter.com/isComputerOn/status/1568344165175508992">@isComputerOn pointed out</a> that this looked a lot like a protocol that has been partially reversed and presented by <a target="_blank" rel="noopener" href="https://twitter.com/nabla_c0d3">Alban Diquet</a> back in 2014. Unfortunately, however brilliant, this research covers the protocol at a very high level and doesn’t really document the packets, their fields and how to establish a connection from anything but a client using the Apple framework. However, this helped me a lot in two ways: first it helped me realize this was not just Logic Pro specific, but that it was part of the <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/multipeerconnectivity">Multipeer Connectivity Framework</a>, and gave me a few hints about the general logic of the protocol itself.</p>
<p>With renewed curiosity and motivation then I jumped into this rabbit hole and managed to reverse engineer all network packets. This allowed me to write a <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw">Python proof of concept client</a> that automatically discovers any MPC servers, initializes the connection and succesfully exchanges application specific data packets.</p>
<p>Moreover, while sending crafted packets and attempting all sorts of things, <strong>I’ve discovered several vulnerabilities in the Apple custom made parsers</strong>. I will <strong>not</strong> discuss them here (exception made for the session spoofing) but at the same time I’m not interested in reporting them to Apple, I’ve heard way too many negative stories about their disclosure program and in general how they mistreat researchers.</p>
<p><img src="/images/2022/crash.png" alt="crash"></p>
<p>Let’s see how this whole thing works! :)</p>
<span id="more"></span>

<h2 class="heading-anchor" id="MultipeerConnectivity-Framework"><a href="#MultipeerConnectivity-Framework" class="anchor-link" aria-hidden="true">#</a><a href="#MultipeerConnectivity-Framework" class="headerlink" title="MultipeerConnectivity Framework"></a>MultipeerConnectivity Framework</h2><p>Apple’s <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/multipeerconnectivity">documentation</a> describes the framework like so:</p>
<blockquote>
<p>The Multipeer Connectivity framework supports the discovery of services provided by nearby devices and supports communicating with those services through message-based data, streaming data, and resources (such as files). In iOS, the framework uses infrastructure Wi-Fi networks, peer-to-peer Wi-Fi, and Bluetooth personal area networks for the underlying transport. In macOS and tvOS, it uses infrastructure Wi-Fi, peer-to-peer Wi-Fi, and Ethernet.</p>
</blockquote>
<p>The document mostly describes how they abstracted the protocol in several classes while being extremely vague about how the thing actually works at the packet level. In reality they mostly reused existing protocols such as MDNS and a customized STUN implementation (in Logic Pro specific case, this doesn’t always apply to apps using this framework), plus a custom TCP based protocol for which they heavily relied on custom (and extremely badly) written parsers.</p>
<h2 class="heading-anchor" id="Discovery-Phase-Multicast-DNS"><a href="#Discovery-Phase-Multicast-DNS" class="anchor-link" aria-hidden="true">#</a><a href="#Discovery-Phase-Multicast-DNS" class="headerlink" title="Discovery Phase: Multicast DNS"></a>Discovery Phase: Multicast DNS</h2><p>The very first thing that I’ve noticed was that, despite the server port being randomized at each application startup, the client application never asked me for the server ip address nor tcp port. This was a strong indicator that something else was happening on the network before the TCP session was being established, as if the server (and possibly the client as well) broadcasted this information in such a way to be automatically discoverable, as also hinted by the wording used in the documentation. </p>
<p>My informed guess was <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multicast_DNS">multicast DNS</a> as I’ve seen this protocol being (ab)used a lot from Apple (<a target="_blank" rel="noopener" href="https://developer.apple.com/bonjour/">Bonjour</a> for instance), and Wireshark confirmed my guess. Both the server and the client are broadcasting their hostnames and peer identifiers (more on this later) on the network so that they can find each other without user interaction.</p>
<p>Here’s how the server advertisement looks like on <a target="_blank" rel="noopener" href="https://github.com/evilsocket/spycast">Spycast</a>:</p>
<p><img src="/images/2022/mdns_server.png" alt="mdns server"></p>
<p>We can see which TCP port is being used (57219), some application specific information in the text record and a weird string “1tvdkfvihbru6”, the <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/multipeerconnectivity/mcpeerid">PeerID</a>.</p>
<p>At the same time, the client is broadcasting some information such as its hostname:</p>
<p><img src="/images/2022/mdns_client.png" alt="mdns client"></p>
<p>Keep in mind that all this data is visible by <strong>anyone</strong> on the same network, this is an important detail as we’ll see shortly when I’ll describe how the spoofing works.</p>
<h2 class="heading-anchor" id="How-a-PeerID-is-made"><a href="#How-a-PeerID-is-made" class="anchor-link" aria-hidden="true">#</a><a href="#How-a-PeerID-is-made" class="headerlink" title="How a PeerID is made"></a>How a PeerID is made</h2><p>Before proceeding to the next part, let’s stop for a moment to see how a peer is identified in this protocol and what that “1tvdkfvihbru6” string is.</p>
<p>Upon startup, each peer is represented by a <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/multipeerconnectivity/mcpeerid">MCPeerID</a> object. Long story short, a random 64bit integer is generated and converted to base36. </p>
<p>So that 1tvdkfvihbru6 in base36 is 8670129607084362000 in base 10. This number is used to uniquely identify the host during the session, regardless of the hostname itself and it’s present in various forms in most of the packets we’re about to see.</p>
<h2 class="heading-anchor" id="Handshake-Phase-Hellos-and-Acks"><a href="#Handshake-Phase-Hellos-and-Acks" class="anchor-link" aria-hidden="true">#</a><a href="#Handshake-Phase-Hellos-and-Acks" class="headerlink" title="Handshake Phase: Hellos and Acks"></a>Handshake Phase: Hellos and Acks</h2><p>After the client discovers the server peer via MDNS the connection is initiated to the TCP port indicated in the advertisement. This is when things started being complicated as the protocol is entirely custom and undocumented. </p>
<p>I needed to work my way from something like this:</p>
<p><img src="/images/2022/hexdata.png" alt="hex data"></p>
<p>To something <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py">like this</a>.</p>
<p>For this task I’ve performed dozens of tests such as:</p>
<ul>
<li>See if similar packets all started with the same signature bytes (they did).</li>
<li>See if by changing the hostname of the client, some other fields (possibly string length fields) changed reflecting the new length (they did).</li>
<li>See if there was any checksum going on by looking at 2 bytes and 4 bytes words that changed depending on the contents (there are).</li>
<li>See if packets were encapsulated with a common header plus a packet-specific payload, which length should be indicated in the header (it is).</li>
</ul>
<p>After a few days of testing I’ve managed to understand that all the packets started with a header that looks like this:</p>
<ul>
<li>The first 2 bytes are the packet signature and determine the packet type (Hello, Ack, Invite, …).</li>
<li>The next 4 bytes are a sequence number plus flags that are used only for some specific payloads.</li>
<li>We then have 2 bytes indicating the payload size after the header.</li>
<li>Following 4 bytes are the CRC32 of the whole packet (i wasn’t sure which checksum was, so <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/utils.py#L13">I bruteforced it</a> :D)</li>
<li>The last 4 bytes of the header are unknown to me but they always seem to contain the same value.</li>
</ul>
<p>With this new knowledge I started looking into the payload of the first packets and identified how the connection handshake works:</p>
<ol>
<li>The client sends an <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L172">Hello packet</a> made of the header and its <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L66">PeerID</a>.</li>
<li>The server responds with an <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L235">Ack packet</a>, made of just the header and no payload.</li>
<li>The server then sends its own Hello packet containing its PeerID (which seems redundant given its already broadcasted via MDNS, but whatever …).</li>
<li>The client sends an Ack to the server Hello.</li>
<li>Finally the client sends an <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L276">Accept packet</a> also only made of the header and no payload, indicating that the first part of the handshake is complete. The reason why the client is responsible for this and not the server will always remain a mystery to me :D</li>
</ol>
<p>You can find the implementation of this handshake process <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/protocol.py#L29">here</a>.</p>
<h2 class="heading-anchor" id="Authorization-Phase-Spoofable-Invites-and-BPlist-inside-BPlist-inside-TCP"><a href="#Authorization-Phase-Spoofable-Invites-and-BPlist-inside-BPlist-inside-TCP" class="anchor-link" aria-hidden="true">#</a><a href="#Authorization-Phase-Spoofable-Invites-and-BPlist-inside-BPlist-inside-TCP" class="headerlink" title="Authorization Phase: Spoofable Invites and BPlist inside BPlist inside TCP"></a>Authorization Phase: Spoofable Invites and BPlist inside BPlist inside TCP</h2><p>After this mutual introduction, the client will send an <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L351">Invitation packet</a> and this is where things start getting covoluted (a la Apple): as we can see from the next picture, the Invite packet is made of the header plus a <a target="_blank" rel="noopener" href="https://medium.com/@karaiskc/understanding-apples-binary-property-list-format-281e6da00dbd">Binary Property List</a> as indicated by the “bplist00” signature visible in cleartext in the packet:</p>
<p><img src="/images/2022/client_invite.png" alt="client invite"></p>
<p>A BPlist is basically a binary encoded XML document, in this case containing the following fields:</p>
<ul>
<li>MCNearbyServiceInviteContextKey: a bplist encoded (yes it’s a bplist inside a bplist …) integer, always 0x2.</li>
<li>MCNearbyServiceInviteIDKey: an integer always set to 0x0.</li>
<li>MCNearbyServiceMessageIDKey: an integer message identifier, always 0x1 for invites.</li>
<li>MCNearbyServiceRecipientPeerIDKey: the message recipient (the server in this case) PeerID, encoded as described next.</li>
<li>MCNearbyServiceSenderPeerIDKey: the message sender (the client) PeerID.</li>
</ul>
<p>In the last two fields, the peer identifiers <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L126">are encoded as</a>:</p>
<ul>
<li>8 bytes containing the numeric peer identifier, big endian.</li>
<li>1 byte containing the peer hostname length.</li>
<li>N bytes containing the unicode peer hostname.</li>
</ul>
<p>The server responds with an Ack and at this point two things can happen: if the client is unknown to the server, a prompt will be shown in order to let the user decide wether to authorize it or not:</p>
<p><img src="/images/2022/server_prompt.png" alt="server prompt"></p>
<p>However, if the client has been previously authorized, no prompt will be shown and the communication will silently continue to the next data exchange step.</p>
<p>At this point you might ask, how does the server store this authorization information? Is it some sort of session cookie? A more advanced cryptographic challenge mechanism? Black magic? Well my friends, often reality is way duller and dumber than what you might imagine :D</p>
<p><strong>They just don’t give a damn and keep a “string peer_hostname -&gt; bool authorized” association … yes, you read that right, client authorization only relies on the (spoofable) client hostname, they don’t even care about the peer identifier number.</strong></p>
<p>Remember how all this information (and more) is being broadcasted in cleartext via MDNS for everyone to enjoy? Yep that’s right, an attacker can wait for a legit client to be authorized and then use its hostname (not on the network, just in the MCNearbyServiceSenderPeerIDKey field) in order to either hijack the legit session, or just create a new one of its own and completely bypass the authorization prompt.</p>
<p><img src="/images/2015/Jan/major-facepalm.jpg" alt="facepalm"></p>
<p>Anyways … if authorized, the server will conclude this phase by sending an <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L673">InviteResponse</a>, which is identical to the client Invite packet, back to the client. You can find the client invite logic <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/protocol.py#L64">here</a> and the wait loop for the server response <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/protocol.py#L79">here</a>.</p>
<p>Let’s continue.</p>
<h2 class="heading-anchor" id="Data-Exchange-Phase"><a href="#Data-Exchange-Phase" class="anchor-link" aria-hidden="true">#</a><a href="#Data-Exchange-Phase" class="headerlink" title="Data Exchange Phase"></a>Data Exchange Phase</h2><p>After the server accepted the invite, the client will proceed by sending a <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L780">ClientData packet</a>, another bplist encoded payload containing the following fields:</p>
<ul>
<li>MCNearbyServiceInviteIDKey: the invite key received with the server InviteResponse.</li>
<li>MCNearbyServiceMessageIDKey: an incremental integer being InviteResponse.MCNearbyServiceMessageIDKey + 1.</li>
<li>MCNearbyServiceRecipientPeerIDKey: client peer id encoded as previously described.</li>
<li>MCNearbyServiceSenderPeerIDKey: server peer id encoded as previously described.</li>
<li>MCNearbyServiceConnectionDataKey: connection data as bplist (again, a bplist inside a bplist …), described next.</li>
</ul>
<p>The interesting part here is the MCNearbyServiceConnectionDataKey field, which contains a bplist encoded <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L550">binary payload</a> made of:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L383">A header</a> composed of:<ul>
<li>1 signature byte (0x80).</li>
<li>1 byte bitmask of security flags indicating if encryption is enabled (not in this case, LOL).</li>
<li>2 bytes indicating the total size of the payload.</li>
<li>1 byte indicating the number of segments / entries in the payload.</li>
</ul>
</li>
<li>A list of IPv4 and IPv6 addresses, one for each network interface of both peers.</li>
<li>A variable number of <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/tcp/messages.py#L474">segments describing each network interface of both peers</a>, made of:<ul>
<li>1 signature byte (0x61).</li>
<li>4 bytes of the numeric peer id (either the client or the server one) trimmed down to 32bits.</li>
<li>4 bytes of a random identifier, my guess is that this creates a new unique identifier together with the previous field.</li>
<li>1 byte indicating the interface type ( ipv4=0x5A ipv6=0x0A ).</li>
<li>3 bytes of padding.</li>
<li>1 byte containing the interface IP index bit-masked with its type.</li>
<li>2 bytes containing an UDP port.</li>
</ul>
</li>
</ol>
<p>Since the application specific part of the protocol works on UDP, by exchanging this data both endpoints become aware of on which possible IP and UDP ports the next part of the communication can happen. </p>
<h2 class="heading-anchor" id="STUN-a-la-Facetime"><a href="#STUN-a-la-Facetime" class="anchor-link" aria-hidden="true">#</a><a href="#STUN-a-la-Facetime" class="headerlink" title="STUN a la Facetime"></a>STUN a la Facetime</h2><p>After the previous step, an Apple custom implementation of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/STUN">STUN</a> is used to determine NAT type and which IP:PORT pair is best suited for the communication. Interestingly, while digging hard into this rabbit hole and reversing other frameworks that were referenced here and there, I found out this is the same exact mechanism that Apple Facetime also uses.</p>
<p>I’ve implemented a very basic <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/stun/server.py#L13">STUN processor here</a>, what happens is:</p>
<ol>
<li>The server will pick one of the IP:UDP_PORT pairs sent in the ClientData and sends a STUN <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/stun/messages.py#L250">Binding Request</a> containing these STUN attributes:<ul>
<li>USERNAME: containing the server and client integer peer identifiers.</li>
<li>ADDRESS_ERROR_CODE: always 0x6.</li>
<li>ALTERNATE_DOMAIN: always 0x03f2.</li>
<li>APPLE_NTP_DELAY: you would see this labled as ICMP by Wireshark, however Apple is using this specific attribute identifier to indicate the NTP delay, as I found out by Ghidra-ing the s*it out of it :D</li>
<li>ICE_CONTROLLING: randomly generate STUN tie breaker / session id.</li>
</ul>
</li>
<li>The client will respond with its own Binding Request, replacing ICE_CONTROLLING with ICE_CONTROLLED and its tie breaker.</li>
<li>The server will send a Binding Response with a MAPPED-ADDRESS attribute indicating the final IP:UDP_PORT pair for the communication.</li>
<li>The client will send its own Binding Response with its UDP MAPPED-ADDRESS.</li>
</ol>
<p>From this point on, an UDP connection is established between the two MAPPED-ADDRESSes and application specific data is exchanged.</p>
<h2 class="heading-anchor" id="Brief-note-on-OSPF"><a href="#Brief-note-on-OSPF" class="anchor-link" aria-hidden="true">#</a><a href="#Brief-note-on-OSPF" class="headerlink" title="Brief note on OSPF"></a>Brief note on OSPF</h2><p>Despite the Logic Pro specific protocol happening after all these steps is out of the scope of this post, I want to briefly mention how it works.</p>
<p>Interestingly, this protocol is referenced as OSPF from the framework:</p>
<p><img src="/images/2022/ospf.png" alt="ospf?"></p>
<p>Howver it has almost nothing in common with the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Open_Shortest_Path_First">Open Shortest Path First</a> protocol. Despite some of these function names reference valid OSPF messages such as LSA, LSAACK and so on, the Apple implementation is entirely different.</p>
<p>You can find a partial <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/ospf/session.py">python implementation here</a> that will be used after the previous step in order to correctly start the “OSPF” session and start receiving data from the server. </p>
<p>In this case, each packet is made of <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/ospf/messages.py#L11">this header</a>:</p>
<ul>
<li>1 byte of protocol type signature (0xc1).</li>
<li>1 byte of packet type signature.</li>
<li>2 bytes of packet size.</li>
<li>2 bytes indicating OSPF channel, mostly unused.</li>
<li>2 bytes with the packet CRC16/ARC checksum (again, <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/utils.py#L10">bruteforcing</a> the type of checksum helped a lot).</li>
<li>4 bytes of the sender peer id.</li>
<li>4 bytes of the receiver peer id.</li>
</ul>
<p>Following, the packet specific payload. </p>
<p>You can find the definitions of some of <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/ospf/messages.py">the Logic Pro packets here</a> and the OSPF server code that will initialize the session and start <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw/blob/main/mpc/ospf/session.py">getting server updates here</a>.</p>
<h2 class="heading-anchor" id="Conclusion"><a href="#Conclusion" class="anchor-link" aria-hidden="true">#</a><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This has definitely been a fun ride during which I’ve learned a lot of new stuff about how Apple frameworks handle network communications. I want to reiterate my gratitude to <a target="_blank" rel="noopener" href="https://twitter.com/nabla_c0d3">Alban Diquet</a> for his research and to <a target="_blank" rel="noopener" href="https://twitter.com/isComputerOn">@isComputerOn</a> for pointing me to the right direction when I was about to give up on what it seemed something entirely irrelevant, thanks you so much guys! &lt;3</p>
<p>I also want to comment on something i’ve heard during a talk presented at the last <a target="_blank" rel="noopener" href="https://twitter.com/0x41con">0x41 conference</a>.<br>The researcher who was presenting and who specialized in fuzzing Apple products, mentioned how at the beginning of his path, someone who’s highly respected and recognized in the infosec community and industry, told him that “fuzzing Apple’s network protocols was a dumb idea”, which unfortunately convinced the researcher to look elsewhere. </p>
<p>Well, my highly respected and recognized dude, I can tell you it is <strong>not</strong> a dumb idea, <strong>at all</strong>, there’s <strong>a lot</strong> of unexplored attack surface there. What was dumb, very close-minded and ignorant, is your take about it.</p>
<p>Anyways … <a target="_blank" rel="noopener" href="https://github.com/evilsocket/mpcfw">you can find the project on my github</a> as usual, enjoy!</p>

  </div>

  
    <div class="post-tags">
      
        <a href="/tags/re/" class="tag">#re</a>
      
        <a href="/tags/network/" class="tag">#network</a>
      
        <a href="/tags/macos-security/" class="tag">#macos security</a>
      
        <a href="/tags/protocol-reversing/" class="tag">#protocol reversing</a>
      
        <a href="/tags/apple/" class="tag">#apple</a>
      
        <a href="/tags/reverse-engineering/" class="tag">#reverse engineering</a>
      
        <a href="/tags/multipeerconnectivity/" class="tag">#multipeerconnectivity</a>
      
        <a href="/tags/mpc-framework/" class="tag">#mpc framework</a>
      
        <a href="/tags/framework/" class="tag">#framework</a>
      
        <a href="/tags/multipeer/" class="tag">#multipeer</a>
      
        <a href="/tags/wireshark/" class="tag">#wireshark</a>
      
        <a href="/tags/network-packets/" class="tag">#network packets</a>
      
        <a href="/tags/network-protocol/" class="tag">#network protocol</a>
      
        <a href="/tags/tcp/" class="tag">#tcp</a>
      
        <a href="/tags/stun/" class="tag">#stun</a>
      
        <a href="/tags/facetime/" class="tag">#facetime</a>
      
        <a href="/tags/mcpeer/" class="tag">#mcpeer</a>
      
        <a href="/tags/mcpeerid/" class="tag">#mcpeerid</a>
      
        <a href="/tags/mdns/" class="tag">#mdns</a>
      
        <a href="/tags/ospf/" class="tag">#ospf</a>
      
        <a href="/tags/ice/" class="tag">#ice</a>
      
        <a href="/tags/proprietary-protocol/" class="tag">#proprietary protocol</a>
      
        <a href="/tags/ios/" class="tag">#ios</a>
      
    </div>
  

  <nav class="post-navigation">
    
      <a href="/2023/11/02/Enumerate-Bruteforce-Attack-All-The-Things-Presenting-Legba/" class="nav-prev">
        <span class="nav-label">PREVIOUS</span>
        <span class="nav-title">Enumerate/Bruteforce/Attack All the Things! Presenting Legba</span>
      </a>
    
    
      <a href="/2022/08/15/Process-behaviour-anomaly-detection-using-eBPF-and-unsupervised-learning-Autoencoders/" class="nav-next">
        <span class="nav-label">NEXT</span>
        <span class="nav-title">Process Behaviour Anomaly Detection Using eBPF and Unsupervised-Learning Autoencoders</span>
      </a>
    
  </nav>
</article>


  


<section class="related-posts">
  <h2 class="related-title">YOU MIGHT ALSO LIKE...</h2>
  <div class="cards-grid cards-grid-related">
    
      

<article class="card card-light">
  <a href="/2025/12/18/TP-Link-Tapo-C200-Hardcoded-Keys-Buffer-Overflows-and-Privacy-in-the-Era-of-AI-Assisted-Reverse-Engineering/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2025/tapo/header.jpg')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">TP-Link Tapo C200: Hardcoded Keys, Buffer Overflows and Privacy in the Era of AI Assisted Reverse Engineering</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2018/02/27/All-hail-bettercap-2-0-one-tool-to-rule-them-all/" class="card-link">
    
      <div class="card-image" style="background-image: url('https://www.bettercap.org/img/logo.png')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">All Hail Bettercap 2.0, One Tool to Rule Them All.</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2017/08/25/Mini-Post-Hacking-a-Herb-Vaporizer-using-GNU-Linux-and-BLE-raw-commands/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2017/08/ble_1.png')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Hacking a Herb Vaporizer to Set Its Temperature Limit From 190C to 6553.5C Remotely</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-light">
  <a href="/2017/04/27/Android-Applications-Reversing-101/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2017/04/head.jpeg')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">Android Applications Reversing 101</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
  </div>
</section>




  </main>
  
  <footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-social">
      
        
          
            <a href="https://github.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
        
          
            <a href="https://twitter.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
          
        
          
            <a href="http://it.linkedin.com/in/simonemargaritelli/" class="social-link" target="_blank" rel="noopener" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
          
        
          
        
          
            <a href="mailto:evilsocket@gmail.com" class="social-link" aria-label="Email">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </a>
          
        
      
    </div>
    <p class="footer-copyright">
      &copy; 2026 evilsocket. 
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>.
    </p>
  </div>
</footer>

  <script src="/a.js"></script>
<script type="text/javascript">
  A['\u0069\u006E\u0069\u0074']({ '\u0061\u0063\u0074\u0069\u006F\u006E': 'none', "statsEndpoint": "\u0068\u0074\u0074\u0070\u0073\u003A\u002F\u002F\u006E\u006F\u0062\u006F\u0074\u002D\u0073\u0074\u0061\u0074\u0073\u002E\u0065\u0076\u0069\u006C\u0073\u006F\u0063\u006B\u0065\u0074\u002E\u0077\u006F\u0072\u006B\u0065\u0072\u0073\u002E\u0064\u0065\u0076\u002F\u006C\u006F\u0067" });
</script>

<!-- Minimal JS - no external dependencies needed -->
<script>
  // Lazy load images
  document.addEventListener('DOMContentLoaded', function () {
    var images = document.querySelectorAll('.card-image[data-bg]');
    images.forEach(function (img) {
      img.style.backgroundImage = 'url(' + img.dataset.bg + ')';
    });
  });
</script>
</body>
</html>
